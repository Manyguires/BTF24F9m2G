<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Contacts">
<meta name="theme-color" content="#0d0d14">
<title>Mes Contacts</title>
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230d0d14' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' font-size='50'>üìã</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#0d0d14;--bg2:#13131f;--bg3:#1a1a2e;--border:#1e1e2e;
  --text:#e8e6f0;--text2:#c8c6d2;--text3:#7a7a8e;--text4:#5a5a6e;--text5:#3a3a4e;
  --gold:#c9a44a;--gold2:#a6832a;--gold-bg:rgba(201,164,74,0.08);--gold-bg2:rgba(201,164,74,0.12);
  --red:#ff6b6b;--red-bg:rgba(255,107,107,0.08);
  --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom);
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text2);font-family:'DM Sans',sans-serif;font-size:14px}
input,textarea,select,button{font-family:inherit;font-size:inherit}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--gold)!important;box-shadow:0 0 0 2px rgba(201,164,74,0.15)!important}
input::placeholder,textarea::placeholder{color:var(--text4)}
::-webkit-scrollbar{width:0;height:0}

/* APP LAYOUT */
#app{display:flex;flex-direction:column;height:100%;padding-top:var(--safe-top)}

/* HEADER */
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(13,13,20,0.9);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);flex-shrink:0;z-index:10}
.header-left{display:flex;align-items:center;gap:10px}
.logo{font-size:20px}
.app-title{font-size:16px;font-weight:700;color:var(--text);letter-spacing:-0.3px}
.count-badge{background:var(--bg3);color:var(--gold);font-size:10px;font-weight:600;padding:2px 8px;border-radius:20px;font-family:'JetBrains Mono',monospace}
.header-right{display:flex;align-items:center;gap:6px}
.icon-btn{background:transparent;border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:15px;cursor:pointer;color:var(--text3);display:flex;align-items:center}
.add-btn{background:linear-gradient(135deg,var(--gold),var(--gold2));color:var(--bg);border:none;border-radius:8px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer}

/* VIEWS */
.view{flex:1;overflow-y:auto;padding-bottom:var(--safe-bottom)}
.view.hidden{display:none}

/* LIST VIEW */
.search-bar{padding:12px 16px 8px}
.search-input{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-size:13px}
.filters{display:flex;gap:6px;padding:0 16px 10px}
.filter-select{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:6px 8px;color:var(--text3);font-size:11px;cursor:pointer;-webkit-appearance:none;appearance:none}
.contact-list{padding:0 10px 20px}
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state .icon{font-size:40px;margin-bottom:12px}
.empty-state .sub{font-size:12px;color:var(--text4);margin-top:6px}

.contact-card{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;cursor:pointer;transition:background 0.15s;margin-bottom:2px;border-left:3px solid transparent;-webkit-user-select:none;user-select:none}
.contact-card:active{background:var(--gold-bg)}
.contact-card.active{background:var(--gold-bg);border-left-color:var(--gold)}
.avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#1e1e3a,#2a2a4e);display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:var(--gold);flex-shrink:0}
.avatar.large{width:60px;height:60px;font-size:26px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:var(--bg)}
.c-info{flex:1;min-width:0}
.c-name{font-size:14px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-sub{font-size:11px;color:var(--text4);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pct-badge{background:var(--gold-bg2);color:var(--gold);font-size:11px;font-weight:600;padding:2px 8px;border-radius:6px;font-family:'JetBrains Mono',monospace;flex-shrink:0}

/* DETAIL VIEW */
.detail-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;position:sticky;top:0;background:rgba(13,13,20,0.9);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:5}
.back-btn{background:transparent;border:1px solid var(--border);color:var(--text3);border-radius:8px;padding:6px 14px;font-size:13px;cursor:pointer}
.detail-actions{display:flex;gap:6px;align-items:center}
.edit-btn{background:var(--gold-bg);border:1px solid rgba(201,164,74,0.2);color:var(--gold);border-radius:8px;padding:6px 14px;font-size:13px;cursor:pointer}
.del-btn{background:var(--red-bg);border:1px solid rgba(255,107,107,0.15);color:var(--red);border-radius:8px;padding:6px 10px;font-size:14px;cursor:pointer}
.confirm-row{display:flex;align-items:center;gap:6px}
.confirm-yes{background:var(--red);color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:12px;cursor:pointer}
.confirm-no{background:var(--border);color:var(--text3);border:none;border-radius:6px;padding:4px 12px;font-size:12px;cursor:pointer}

.profile-card{background:linear-gradient(135deg,rgba(201,164,74,0.05),rgba(15,15,24,0.8));border:1px solid var(--border);border-radius:16px;padding:20px;margin:0 16px 16px;display:flex;align-items:center;gap:16px}
.profile-name{font-size:20px;font-weight:700;color:var(--text);letter-spacing:-0.3px}
.profile-role{font-size:13px;color:var(--text3);margin-top:3px}
.tag-row{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.tag{background:var(--gold-bg);color:var(--gold);font-size:10px;padding:2px 9px;border-radius:12px;font-weight:500}

.fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;padding:0 16px 16px}
.field-card{display:flex;align-items:flex-start;gap:10px;background:var(--bg2);border:1px solid var(--bg3);border-radius:12px;padding:12px 14px}
.field-icon{font-size:16px;flex-shrink:0;margin-top:1px}
.field-label{font-size:9px;color:var(--text4);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;margin-bottom:2px}
.field-value{font-size:13px;color:var(--text);font-weight:500;word-break:break-word}

.notes-box{background:var(--bg2);border:1px solid var(--bg3);border-radius:12px;padding:16px;margin:0 16px 12px}
.notes-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:8px}
.notes-text{font-size:13px;line-height:1.7;color:#9a98a6;white-space:pre-wrap}
.meta-info{font-size:10px;color:var(--text5);text-align:right;padding:0 16px 20px;font-family:'JetBrains Mono',monospace}

/* FORM VIEW */
.form-header{display:flex;align-items:center;gap:14px;padding:12px 16px;position:sticky;top:0;background:rgba(13,13,20,0.9);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:5}
.form-title{font-size:17px;font-weight:700;color:var(--text)}
.form-body{padding:0 16px 30px}
.form-section{margin-bottom:20px}
.form-section-title{font-size:11px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-group{display:flex;flex-direction:column}
.form-group.full{grid-column:1/-1}
.form-label{font-size:11px;font-weight:600;color:var(--text3);margin-bottom:5px}
.form-input{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-size:13px;transition:all 0.15s}
textarea.form-input{resize:vertical;min-height:80px}
.form-actions{display:flex;gap:10px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border)}
.cancel-btn{flex:1;background:transparent;border:1px solid var(--border);color:var(--text3);border-radius:10px;padding:12px;font-size:14px;font-weight:600;cursor:pointer}
.save-btn{flex:2;background:linear-gradient(135deg,var(--gold),var(--gold2));color:var(--bg);border:none;border-radius:10px;padding:12px;font-size:14px;font-weight:700;cursor:pointer}
.save-btn:disabled{opacity:0.4}

/* WELCOME */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px 20px}
.welcome .icon{font-size:48px;margin-bottom:14px}
.welcome h2{font-size:19px;font-weight:700;color:var(--text);margin-bottom:8px}
.welcome p{color:var(--text3);max-width:320px;line-height:1.6;font-size:13px}
.stats-row{display:flex;gap:14px;margin-top:24px}
.stat-box{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px 24px;text-align:center}
.stat-num{font-size:24px;font-weight:700;color:var(--gold);font-family:'JetBrains Mono',monospace}
.stat-label{font-size:10px;color:var(--text4);margin-top:3px;text-transform:uppercase;letter-spacing:0.5px}

/* PIN LOCK */
.lock-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;padding:20px}
.lock-screen.hidden{display:none}
.lock-icon{font-size:56px;margin-bottom:20px}
.lock-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:6px}
.lock-sub{font-size:13px;color:var(--text3);margin-bottom:24px;text-align:center}
.pin-dots{display:flex;gap:12px;margin-bottom:28px}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border);transition:all 0.15s}
.pin-dot.filled{background:var(--gold);border-color:var(--gold)}
.pin-dot.error{border-color:var(--red);background:var(--red)}
.numpad{display:grid;grid-template-columns:repeat(3,72px);gap:10px}
.num-key{width:72px;height:56px;border-radius:14px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:22px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-user-select:none;user-select:none;transition:background 0.1s}
.num-key:active{background:var(--gold-bg)}
.num-key.empty{border:none;background:transparent}
.num-key.action{font-size:14px;color:var(--text3);border:none;background:transparent}
.lock-error{color:var(--red);font-size:12px;margin-top:12px;min-height:18px}
.lock-setup-text{font-size:12px;color:var(--text4);margin-top:8px}

/* SETTINGS OVERLAY */
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:50;display:flex;align-items:flex-end;justify-content:center}
.settings-overlay.hidden{display:none}
.settings-panel{background:var(--bg);border-top:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:70vh;overflow-y:auto;padding:20px 20px calc(20px + var(--safe-bottom))}
.settings-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 16px}
.settings-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:16px}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border)}
.settings-item-label{font-size:14px;color:var(--text2)}
.settings-item-sub{font-size:11px;color:var(--text4);margin-top:2px}
.toggle{width:44px;height:26px;border-radius:13px;background:var(--border);cursor:pointer;position:relative;transition:background 0.2s;flex-shrink:0}
.toggle.on{background:var(--gold)}
.toggle-knob{width:22px;height:22px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:transform 0.2s}
.toggle.on .toggle-knob{transform:translateX(18px)}
.settings-btn{width:100%;padding:12px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;margin-top:10px;border:none}
.settings-btn.danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(255,107,107,0.15)}
.settings-btn.primary{background:var(--gold-bg);color:var(--gold);border:1px solid rgba(201,164,74,0.2)}

@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
.animate-in{animation:fadeIn 0.25s ease}
.shake{animation:shake 0.3s ease}
</style>
</head>
<body>

<div id="app"></div>

<script>
(function(){
  const STORAGE_KEY = 'crm_private_v3';
  const PIN_KEY = 'crm_pin_v3';
  const LOCK_KEY = 'crm_lock_enabled_v3';

  const FIELDS = [
    {section:'Identit√©',fields:[
      {key:'prenom',label:'Pr√©nom',icon:'‚úèÔ∏è',type:'text'},
      {key:'nom',label:'Nom',icon:'üë§',type:'text'},
      {key:'telephone',label:'T√©l√©phone',icon:'üì±',type:'tel'},
      {key:'email',label:'Email',icon:'‚úâÔ∏è',type:'email'},
      {key:'username',label:'Username',icon:'üîë',type:'text'},
      {key:'dateNaissance',label:'Date de naissance',icon:'üéÇ',type:'date'},
    ]},
    {section:'Professionnel',fields:[
      {key:'entreprise',label:'Entreprise',icon:'üè¢',type:'text'},
      {key:'poste',label:'Poste / Fonction',icon:'üíº',type:'text'},
      {key:'villeTravail',label:'Ville de travail',icon:'üèôÔ∏è',type:'text'},
      {key:'salaire',label:'Salaire',icon:'üí∞',type:'number',suffix:'‚Ç¨'},
      {key:'pourcentage',label:'% (Commission/Deal)',icon:'üìä',type:'number',suffix:'%'},
    ]},
    {section:'Autres',fields:[
      {key:'adresse',label:'Adresse',icon:'üìç',type:'text',full:true},
      {key:'tags',label:'Tags (s√©par√©s par virgule)',icon:'üè∑Ô∏è',type:'text',full:true,placeholder:'ex: VIP, prospect, partenaire'},
      {key:'dernierContact',label:'Dernier contact',icon:'üìÖ',type:'date'},
      {key:'notes',label:'Notes priv√©es',icon:'üìù',type:'textarea',full:true},
    ]},
  ];

  const ALL_FIELD_KEYS = FIELDS.flatMap(s=>s.fields.map(f=>f.key));
  const FIELD_MAP = {};
  FIELDS.forEach(s=>s.fields.forEach(f=>{FIELD_MAP[f.key]=f}));

  // State
  let contacts = [];
  let currentView = 'list'; // list, detail, form
  let selectedId = null;
  let editingContact = null;
  let searchQuery = '';
  let sortBy = 'nom';
  let filterTag = '';
  let confirmDeleteId = null;
  let pinLocked = false;
  let pinBuffer = '';
  let pinMode = 'unlock'; // unlock, setup, confirm-setup
  let pinSetupFirst = '';
  let pinError = '';
  let showSettings = false;

  // Storage
  function loadContacts(){
    try{const d=localStorage.getItem(STORAGE_KEY);contacts=d?JSON.parse(d):[];}catch(e){contacts=[];}
  }
  function saveContacts(){
    localStorage.setItem(STORAGE_KEY,JSON.stringify(contacts));
  }
  function getPin(){return localStorage.getItem(PIN_KEY)}
  function setPin(p){localStorage.setItem(PIN_KEY,p)}
  function removePin(){localStorage.removeItem(PIN_KEY)}
  function isLockEnabled(){return localStorage.getItem(LOCK_KEY)==='1'}
  function setLockEnabled(v){localStorage.setItem(LOCK_KEY,v?'1':'0')}

  // Init
  loadContacts();
  if(isLockEnabled()&&getPin()){pinLocked=true;pinMode='unlock';}

  // Render
  function render(){
    const app=document.getElementById('app');
    app.innerHTML='';
    // Lock screen
    app.innerHTML+=renderLockScreen();
    // Settings overlay
    app.innerHTML+=renderSettings();
    // Main app
    app.innerHTML+=`<div class="header">${renderHeader()}</div>`;
    app.innerHTML+=renderListView();
    app.innerHTML+=renderDetailView();
    app.innerHTML+=renderFormView();
    bindEvents();
  }

  function renderLockScreen(){
    const dots=Array.from({length:4},(_,i)=>{
      let cls='pin-dot';
      if(pinError)cls+=' error';
      else if(i<pinBuffer.length)cls+=' filled';
      return `<div class="${cls}"></div>`;
    }).join('');
    let title='Entrer le code PIN';
    let sub='Acc√®s prot√©g√© √† vos contacts';
    if(pinMode==='setup'){title='Cr√©er un code PIN';sub='Choisissez 4 chiffres';}
    if(pinMode==='confirm-setup'){title='Confirmer le PIN';sub='Entrez √† nouveau votre code';}
    return `
      <div class="lock-screen ${pinLocked?'':'hidden'}" id="lockScreen">
        <div class="lock-icon">üîê</div>
        <div class="lock-title">${title}</div>
        <div class="lock-sub">${sub}</div>
        <div class="pin-dots" id="pinDots">${dots}</div>
        <div class="numpad">
          ${[1,2,3,4,5,6,7,8,9].map(n=>`<div class="num-key" data-num="${n}">${n}</div>`).join('')}
          <div class="num-key action" data-num="cancel">Annuler</div>
          <div class="num-key" data-num="0">0</div>
          <div class="num-key action" data-num="del">‚å´</div>
        </div>
        <div class="lock-error" id="pinErrorMsg">${pinError}</div>
      </div>`;
  }

  function renderSettings(){
    const hasPin=!!getPin();
    const lockOn=isLockEnabled();
    return `
      <div class="settings-overlay ${showSettings?'':'hidden'}" id="settingsOverlay">
        <div class="settings-panel">
          <div class="settings-handle"></div>
          <div class="settings-title">‚öôÔ∏è Param√®tres</div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">üîí Verrouillage par PIN</div>
              <div class="settings-item-sub">${hasPin?'PIN configur√©':'Aucun PIN configur√©'}</div>
            </div>
            <div class="toggle ${lockOn&&hasPin?'on':''}" id="toggleLock">
              <div class="toggle-knob"></div>
            </div>
          </div>
          ${hasPin?`<button class="settings-btn primary" id="changePinBtn">Changer le PIN</button>`:''}
          <button class="settings-btn danger" id="exportBtn">üì§ Exporter mes donn√©es (JSON)</button>
          <label class="settings-btn primary" style="text-align:center;display:block">
            üì• Importer des donn√©es
            <input type="file" accept=".json" id="importInput" style="display:none">
          </label>
          <button class="settings-btn danger" id="deleteAllBtn" style="margin-top:20px">üóëÔ∏è Supprimer toutes les donn√©es</button>
        </div>
      </div>`;
  }

  function renderHeader(){
    return `
      <div class="header-left">
        <span class="logo">üîí</span>
        <span class="app-title">Mes Contacts</span>
        <span class="count-badge">${contacts.length}</span>
      </div>
      <div class="header-right">
        <button class="icon-btn" id="settingsBtn">‚öôÔ∏è</button>
        <button class="add-btn" id="addBtn">+ Nouveau</button>
      </div>`;
  }

  function getFilteredContacts(){
    const q=searchQuery.toLowerCase();
    return contacts
      .filter(c=>{
        const matchQ=!q||Object.values(c).some(v=>typeof v==='string'&&v.toLowerCase().includes(q));
        const matchTag=!filterTag||(c.tags&&c.tags.toLowerCase().includes(filterTag.toLowerCase()));
        return matchQ&&matchTag;
      })
      .sort((a,b)=>(a[sortBy]||'').toLowerCase().localeCompare((b[sortBy]||'').toLowerCase()));
  }

  function getAllTags(){
    return [...new Set(contacts.flatMap(c=>c.tags?c.tags.split(',').map(t=>t.trim()).filter(Boolean):[]))];
  }

  function renderListView(){
    const filtered=getFilteredContacts();
    const tags=getAllTags();
    const tagOptions=tags.map(t=>`<option value="${t}">${t}</option>`).join('');
    let listHTML='';
    if(filtered.length===0){
      if(contacts.length===0){
        listHTML=`<div class="empty-state"><div class="icon">üìã</div><div>Aucun contact</div><div class="sub">Appuie sur "+ Nouveau"</div></div>`;
      }else{
        listHTML=`<div class="empty-state"><div class="icon">üîç</div><div>Aucun r√©sultat</div></div>`;
      }
    }else{
      listHTML=filtered.map(c=>`
        <div class="contact-card animate-in" data-id="${c.id}">
          <div class="avatar">${(c.prenom?.[0]||c.nom?.[0]||'?').toUpperCase()}</div>
          <div class="c-info">
            <div class="c-name">${esc(c.prenom)} ${esc(c.nom)}</div>
            <div class="c-sub">${esc([c.entreprise,c.villeTravail].filter(Boolean).join(' ¬∑ '))||'‚Äî'}</div>
          </div>
          ${c.pourcentage?`<div class="pct-badge">${esc(c.pourcentage)}%</div>`:''}
        </div>`).join('');
    }

    return `
      <div class="view ${currentView==='list'?'':'hidden'}" id="listView">
        <div class="search-bar">
          <input class="search-input" id="searchInput" placeholder="üîç  Rechercher..." value="${esc(searchQuery)}">
        </div>
        <div class="filters">
          <select class="filter-select" id="sortSelect">
            <option value="nom" ${sortBy==='nom'?'selected':''}>Nom</option>
            <option value="entreprise" ${sortBy==='entreprise'?'selected':''}>Entreprise</option>
            <option value="villeTravail" ${sortBy==='villeTravail'?'selected':''}>Ville</option>
            <option value="dateAjout" ${sortBy==='dateAjout'?'selected':''}>Date</option>
          </select>
          ${tags.length?`<select class="filter-select" id="tagSelect">
            <option value="">Tous tags</option>${tagOptions}
          </select>`:''}
        </div>
        <div class="contact-list" id="contactList">${listHTML}</div>
      </div>`;
  }

  function renderDetailView(){
    if(currentView!=='detail'||!selectedId)return `<div class="view hidden" id="detailView"></div>`;
    const c=contacts.find(x=>x.id===selectedId);
    if(!c)return `<div class="view hidden" id="detailView"></div>`;

    const tags=c.tags?c.tags.split(',').map(t=>t.trim()).filter(Boolean):[];
    const tagHTML=tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('');

    const fieldsHTML=FIELDS.flatMap(s=>s.fields).filter(f=>f.key!=='notes'&&f.key!=='tags'&&c[f.key]).map(f=>{
      let val=esc(c[f.key]);
      if(f.suffix)val+=f.suffix;
      return `<div class="field-card">
        <div class="field-icon">${f.icon}</div>
        <div><div class="field-label">${f.label}</div><div class="field-value">${val}</div></div>
      </div>`;
    }).join('');

    let deleteHTML;
    if(confirmDeleteId===c.id){
      deleteHTML=`<div class="confirm-row">
        <span style="color:var(--red);font-size:12px">S√ªr ?</span>
        <button class="confirm-yes" id="confirmYes">Oui</button>
        <button class="confirm-no" id="confirmNo">Non</button>
      </div>`;
    }else{
      deleteHTML=`<button class="del-btn" id="delBtn">üóëÔ∏è</button>`;
    }

    return `
      <div class="view ${currentView==='detail'?'':'hidden'} animate-in" id="detailView">
        <div class="detail-header">
          <button class="back-btn" id="backBtn">‚Üê Retour</button>
          <div class="detail-actions">
            <button class="edit-btn" id="editBtn">‚úèÔ∏è Modifier</button>
            ${deleteHTML}
          </div>
        </div>
        <div class="profile-card">
          <div class="avatar large">${(c.prenom?.[0]||c.nom?.[0]||'?').toUpperCase()}</div>
          <div>
            <div class="profile-name">${esc(c.prenom)} ${esc(c.nom)}</div>
            <div class="profile-role">${esc([c.poste,c.entreprise].filter(Boolean).join(' ‚Äî '))||'‚Äî'}</div>
            ${tagHTML?`<div class="tag-row">${tagHTML}</div>`:''}
          </div>
        </div>
        <div class="fields-grid">${fieldsHTML}</div>
        ${c.notes?`<div class="notes-box"><div class="notes-title">üìù Notes priv√©es</div><div class="notes-text">${esc(c.notes)}</div></div>`:''}
        <div class="meta-info">Ajout√© le ${c.dateAjout||'‚Äî'}</div>
      </div>`;
  }

  function renderFormView(){
    if(currentView!=='form'||!editingContact)return `<div class="view hidden" id="formView"></div>`;
    const c=editingContact;
    const isNew=!contacts.find(x=>x.id===c.id);

    const sectionsHTML=FIELDS.map(s=>{
      const fieldsHTML=s.fields.map(f=>{
        const val=esc(c[f.key]||'');
        const fullCls=f.full?'full':'';
        if(f.type==='textarea'){
          return `<div class="form-group ${fullCls}">
            <label class="form-label">${f.icon} ${f.label}</label>
            <textarea class="form-input" data-field="${f.key}" placeholder="${f.placeholder||''}">${val}</textarea>
          </div>`;
        }
        return `<div class="form-group ${fullCls}">
          <label class="form-label">${f.icon} ${f.label}</label>
          <input class="form-input" type="${f.type}" data-field="${f.key}" value="${val}" placeholder="${f.placeholder||''}">
        </div>`;
      }).join('');
      return `<div class="form-section">
        <div class="form-section-title">${s.section}</div>
        <div class="form-grid">${fieldsHTML}</div>
      </div>`;
    }).join('');

    return `
      <div class="view ${currentView==='form'?'':'hidden'} animate-in" id="formView">
        <div class="form-header">
          <button class="back-btn" id="formBackBtn">‚Üê Annuler</button>
          <span class="form-title">${isNew?'Nouveau contact':'Modifier'}</span>
        </div>
        <div class="form-body">
          ${sectionsHTML}
          <div class="form-actions">
            <button class="cancel-btn" id="formCancelBtn">Annuler</button>
            <button class="save-btn" id="formSaveBtn">üíæ Enregistrer</button>
          </div>
        </div>
      </div>`;
  }

  // EVENTS
  function bindEvents(){
    // Lock screen
    document.querySelectorAll('.num-key').forEach(k=>{
      k.addEventListener('click',()=>handlePinKey(k.dataset.num));
    });

    // Settings overlay close
    const overlay=document.getElementById('settingsOverlay');
    if(overlay)overlay.addEventListener('click',e=>{if(e.target===overlay){showSettings=false;render();}});

    const toggleLock=document.getElementById('toggleLock');
    if(toggleLock)toggleLock.addEventListener('click',handleToggleLock);

    const changePinBtn=document.getElementById('changePinBtn');
    if(changePinBtn)changePinBtn.addEventListener('click',()=>{
      showSettings=false;pinLocked=true;pinMode='setup';pinBuffer='';pinError='';render();
    });

    const exportBtn=document.getElementById('exportBtn');
    if(exportBtn)exportBtn.addEventListener('click',handleExport);

    const importInput=document.getElementById('importInput');
    if(importInput)importInput.addEventListener('change',handleImport);

    const deleteAllBtn=document.getElementById('deleteAllBtn');
    if(deleteAllBtn)deleteAllBtn.addEventListener('click',()=>{
      if(confirm('Supprimer TOUS les contacts ? Cette action est irr√©versible.')){
        contacts=[];saveContacts();selectedId=null;currentView='list';showSettings=false;render();
      }
    });

    // Header
    const settingsBtn=document.getElementById('settingsBtn');
    if(settingsBtn)settingsBtn.addEventListener('click',()=>{showSettings=true;render();});

    const addBtn=document.getElementById('addBtn');
    if(addBtn)addBtn.addEventListener('click',()=>{
      editingContact={id:genId(),dateAjout:today()};
      ALL_FIELD_KEYS.forEach(k=>{if(!editingContact[k])editingContact[k]='';});
      currentView='form';render();
    });

    // Search
    const searchInput=document.getElementById('searchInput');
    if(searchInput){
      searchInput.addEventListener('input',e=>{searchQuery=e.target.value;render();
        document.getElementById('searchInput').focus();
        document.getElementById('searchInput').selectionStart=searchQuery.length;
      });
    }

    // Sort/filter
    const sortSelect=document.getElementById('sortSelect');
    if(sortSelect)sortSelect.addEventListener('change',e=>{sortBy=e.target.value;render();});
    const tagSelect=document.getElementById('tagSelect');
    if(tagSelect)tagSelect.addEventListener('change',e=>{filterTag=e.target.value;render();});

    // Contact cards
    document.querySelectorAll('.contact-card').forEach(card=>{
      card.addEventListener('click',()=>{selectedId=card.dataset.id;currentView='detail';render();});
    });

    // Detail
    const backBtn=document.getElementById('backBtn');
    if(backBtn)backBtn.addEventListener('click',()=>{selectedId=null;confirmDeleteId=null;currentView='list';render();});

    const editBtn=document.getElementById('editBtn');
    if(editBtn)editBtn.addEventListener('click',()=>{
      const c=contacts.find(x=>x.id===selectedId);
      if(c){editingContact={...c};currentView='form';render();}
    });

    const delBtn=document.getElementById('delBtn');
    if(delBtn)delBtn.addEventListener('click',()=>{confirmDeleteId=selectedId;render();});

    const confirmYes=document.getElementById('confirmYes');
    if(confirmYes)confirmYes.addEventListener('click',()=>{
      contacts=contacts.filter(c=>c.id!==selectedId);saveContacts();
      selectedId=null;confirmDeleteId=null;currentView='list';render();
    });
    const confirmNo=document.getElementById('confirmNo');
    if(confirmNo)confirmNo.addEventListener('click',()=>{confirmDeleteId=null;render();});

    // Form
    const formBackBtn=document.getElementById('formBackBtn');
    const formCancelBtn=document.getElementById('formCancelBtn');
    [formBackBtn,formCancelBtn].forEach(btn=>{
      if(btn)btn.addEventListener('click',()=>{editingContact=null;currentView=selectedId?'detail':'list';render();});
    });

    document.querySelectorAll('.form-input').forEach(input=>{
      input.addEventListener('input',e=>{
        if(editingContact)editingContact[e.target.dataset.field]=e.target.value;
      });
    });

    const formSaveBtn=document.getElementById('formSaveBtn');
    if(formSaveBtn)formSaveBtn.addEventListener('click',()=>{
      if(!editingContact||(!editingContact.nom&&!editingContact.prenom))return;
      const exists=contacts.find(c=>c.id===editingContact.id);
      if(exists){contacts=contacts.map(c=>c.id===editingContact.id?{...editingContact}:c);}
      else{contacts.push({...editingContact});}
      saveContacts();
      selectedId=editingContact.id;editingContact=null;currentView='detail';render();
    });
  }

  // PIN logic
  function handlePinKey(key){
    if(key==='cancel'){
      if(pinMode==='setup'||pinMode==='confirm-setup'){
        pinLocked=false;pinBuffer='';pinError='';pinMode='unlock';showSettings=false;render();
      }
      return;
    }
    if(key==='del'){pinBuffer=pinBuffer.slice(0,-1);pinError='';render();return;}
    if(pinBuffer.length>=4)return;
    pinBuffer+=key;
    pinError='';
    render();
    if(pinBuffer.length===4){
      setTimeout(()=>processPinEntry(),150);
    }
  }

  function processPinEntry(){
    if(pinMode==='unlock'){
      if(pinBuffer===getPin()){
        pinLocked=false;pinBuffer='';pinError='';render();
      }else{
        pinError='Code incorrect';pinBuffer='';render();
        document.getElementById('pinDots')?.classList.add('shake');
      }
    }else if(pinMode==='setup'){
      pinSetupFirst=pinBuffer;pinBuffer='';pinMode='confirm-setup';render();
    }else if(pinMode==='confirm-setup'){
      if(pinBuffer===pinSetupFirst){
        setPin(pinBuffer);setLockEnabled(true);
        pinLocked=false;pinBuffer='';pinError='';pinMode='unlock';render();
      }else{
        pinError='Les codes ne correspondent pas';pinBuffer='';pinMode='setup';pinSetupFirst='';render();
        document.getElementById('pinDots')?.classList.add('shake');
      }
    }
  }

  function handleToggleLock(){
    if(isLockEnabled()&&getPin()){
      setLockEnabled(false);render();
    }else{
      if(getPin()){setLockEnabled(true);render();}
      else{showSettings=false;pinLocked=true;pinMode='setup';pinBuffer='';pinError='';render();}
    }
  }

  function handleExport(){
    const blob=new Blob([JSON.stringify(contacts,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=`crm_backup_${today()}.json`;a.click();
    URL.revokeObjectURL(url);
  }

  function handleImport(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(Array.isArray(data)){
          data.forEach(imp=>{if(!contacts.find(c=>c.id===imp.id))contacts.push(imp);});
          saveContacts();showSettings=false;render();
        }
      }catch(err){alert('Fichier invalide');}
    };
    reader.readAsText(file);
    e.target.value='';
  }

  // Helpers
  function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}
  function today(){return new Date().toISOString().split('T')[0]}
  function esc(s){if(!s)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

  // GO
  render();
})();
</script>
</body>
</html>
