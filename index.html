<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MyCRM">
<meta name="theme-color" content="#0b0e14">
<title>Mon CRM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0b0e14;--bg2:#111820;--bg3:#182028;--bg4:#1f2a34;--bg5:#263240;
--border:#1c2733;--border2:#2a3a4a;
--t1:#f0f2f5;--t2:#c4ccd6;--t3:#7e8d9e;--t4:#4e5d6e;--t5:#2e3d4e;
--g:#2ecc71;--g2:#27ae60;--g3:rgba(46,204,113,0.10);--g4:rgba(46,204,113,0.20);
--y:#f1c40f;--y2:rgba(241,196,15,0.12);
--r:#e74c3c;--r2:rgba(231,76,60,0.10);--r3:rgba(231,76,60,0.20);
--b:#3498db;--b2:rgba(52,152,219,0.12);
--o:#e67e22;--o2:rgba(230,126,34,0.12);
--p:#9b59b6;--p2:rgba(155,89,182,0.12);
--st:env(safe-area-inset-top);--sb:env(safe-area-inset-bottom);
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--t2);font-family:'Inter',sans-serif;font-size:14px}
input,textarea,select,button{font-family:inherit;font-size:inherit}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--g)!important;box-shadow:0 0 0 3px var(--g3)!important}
input::placeholder,textarea::placeholder{color:var(--t4)}
select{-webkit-appearance:none}
::-webkit-scrollbar{width:0;height:0}

.lock{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;padding:20px;transition:opacity .3s}
.lock.out{opacity:0;pointer-events:none}
.lock h2{font-size:18px;font-weight:700;color:var(--t1);margin-bottom:4px}
.lock p{font-size:13px;color:var(--t3);margin-bottom:26px;text-align:center}
.dots{display:flex;gap:14px;margin-bottom:30px}
.dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);transition:all .15s}
.dot.on{background:var(--g);border-color:var(--g);transform:scale(1.15)}
.dot.err{background:var(--r);border-color:var(--r)}
.numpad{display:grid;grid-template-columns:repeat(3,74px);gap:10px}
.nk{width:74px;height:58px;border-radius:14px;border:1px solid var(--border);background:var(--bg2);color:var(--t1);font-size:24px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-user-select:none}
.nk:active{background:var(--g3)}
.nk.fn{font-size:13px;color:var(--t3);border:none;background:transparent}
.lock-msg{color:var(--r);font-size:12px;margin-top:14px;min-height:18px}

#app{display:flex;flex-direction:column;height:100%;padding-top:var(--st)}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);background:rgba(11,14,20,0.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);flex-shrink:0;z-index:10}
.hdr-l{display:flex;align-items:center;gap:8px}
.brand{font-size:16px;font-weight:800;color:var(--t1)}.brand span{color:var(--g)}
.cnt{background:var(--g3);color:var(--g);font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;font-family:'JetBrains Mono',monospace}

.nav{display:flex;border-top:1px solid var(--border);background:rgba(11,14,20,0.95);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);flex-shrink:0;padding-bottom:var(--sb);z-index:10}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 0 6px;cursor:pointer;color:var(--t4);font-size:10px;font-weight:600;gap:2px;-webkit-user-select:none}
.nav-item.act{color:var(--g)}
.nav-item .ni{font-size:20px}

.vw{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.vw.hide{display:none}
.anim{animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
.shake{animation:shake .3s}

.btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:13px}
.btn:active{opacity:.7}
.btn-g{background:var(--g);color:#fff;box-shadow:0 2px 10px rgba(46,204,113,0.2)}
.btn-o{background:transparent;border:1px solid var(--border);color:var(--t3)}
.btn-r{background:var(--r2);color:var(--r);border:1px solid var(--r3)}
.btn-s{background:var(--g3);color:var(--g);border:1px solid var(--g4)}

.sbar{padding:10px 16px 6px}
.sinp{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 14px;color:var(--t1);font-size:13px}
.flts{display:flex;gap:6px;padding:2px 16px 8px}
.fsel{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:5px 8px;color:var(--t3);font-size:11px}
.clist{padding:2px 8px 20px}
.empty{text-align:center;padding:50px 20px;color:var(--t3)}
.empty .ei{font-size:40px;margin-bottom:10px}

.cc{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:12px;cursor:pointer;margin-bottom:2px;border-left:3px solid transparent;-webkit-user-select:none}
.cc:active{background:var(--g3)}
.av{width:40px;height:40px;border-radius:50%;background:linear-gradient(140deg,var(--bg3),var(--bg5));display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:var(--g);flex-shrink:0;border:1px solid var(--border)}
.av.lg{width:56px;height:56px;font-size:23px;background:linear-gradient(140deg,var(--g),var(--g2));color:#fff;border:none;box-shadow:0 4px 14px rgba(46,204,113,0.3)}
.ci{flex:1;min-width:0}
.cn{font-size:13px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cs{font-size:11px;color:var(--t4);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cc-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.pb{background:var(--y2);color:var(--y);font-size:10px;font-weight:700;padding:1px 6px;border-radius:5px;font-family:'JetBrains Mono',monospace}
.debt-badge{font-size:10px;font-weight:700;padding:1px 6px;border-radius:5px;font-family:'JetBrains Mono',monospace}
.debt-r{background:var(--r2);color:var(--r)}
.debt-g{background:var(--g3);color:var(--g)}

.dhdr{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;position:sticky;top:0;background:rgba(11,14,20,0.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);z-index:5}
.dacts{display:flex;gap:5px;align-items:center}
.pcard{background:linear-gradient(140deg,rgba(46,204,113,0.06),var(--bg2));border:1px solid var(--border);border-radius:16px;padding:18px;margin:4px 16px 14px;display:flex;align-items:center;gap:14px}
.pname{font-size:19px;font-weight:800;color:var(--t1)}
.prole{font-size:12px;color:var(--t3);margin-top:2px}
.trow{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.tg{background:var(--g3);color:var(--g);font-size:10px;padding:2px 9px;border-radius:12px;font-weight:600}
.fgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;padding:0 16px 14px}
.fc{display:flex;align-items:flex-start;gap:8px;background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:11px 12px}
.fi{font-size:15px;flex-shrink:0}
.fl{font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.7px;font-weight:700;margin-bottom:1px}
.fv{font-size:13px;color:var(--t1);font-weight:500;word-break:break-word}
.nbox{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:14px;margin:0 16px 12px}

.sec{padding:0 16px 14px}
.sec-t{font-size:11px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}

/* INVOICES */
.inv-card{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.inv-left{flex:1;min-width:0}
.inv-desc{font-size:12px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.inv-date{font-size:10px;color:var(--t4);margin-top:2px}
.inv-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.inv-amt{font-size:15px;font-weight:800;font-family:'JetBrains Mono',monospace}
.inv-cur{font-size:10px;font-weight:700;padding:2px 6px;border-radius:5px;font-family:'JetBrains Mono',monospace}
.cur-eur{background:var(--b2);color:var(--b)}.cur-usd{background:var(--g3);color:var(--g)}.cur-tnd{background:var(--o2);color:var(--o)}.cur-credit{background:var(--p2);color:var(--p)}
.inv-status{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;cursor:pointer;-webkit-user-select:none}
.inv-paid{background:var(--g3);color:var(--g)}.inv-pending{background:var(--r2);color:var(--r)}
.inv-del{font-size:13px;cursor:pointer;padding:4px;color:var(--t4)}
.inv-totals{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.inv-total-chip{display:flex;align-items:center;gap:5px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:8px 12px}
.inv-total-label{font-size:10px;color:var(--t4);font-weight:600}
.inv-total-val{font-size:14px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--r)}
.inv-total-val.zero{color:var(--g)}
.add-inv{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}
.add-inv-title{font-size:11px;font-weight:700;color:var(--o);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.add-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.add-row .fg{min-width:0}.add-row .fg.w1{flex:2}.add-row .fg.w2{flex:1}
.paid-toggle{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.pt-opt{padding:7px 12px;font-size:11px;font-weight:600;cursor:pointer;background:var(--bg2);color:var(--t3);-webkit-user-select:none;text-align:center}
.pt-opt.act-g{background:var(--g3);color:var(--g)}.pt-opt.act-r{background:var(--r2);color:var(--r)}

/* MONTHLY CA */
.mth-card{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:12px 14px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.mth-month{font-size:13px;font-weight:600;color:var(--t1)}
.mth-amt{font-size:17px;font-weight:800;color:var(--y);font-family:'JetBrains Mono',monospace}
.mth-total{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.mth-total-label{font-size:11px;color:var(--t3);font-weight:600}
.mth-total-val{font-size:18px;font-weight:800;color:var(--g);font-family:'JetBrains Mono',monospace}
.mth-avg{font-size:12px;color:var(--t3);font-weight:600}

.chart-box{margin:0 16px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px;overflow:hidden}
.chart-box canvas{width:100%;height:140px}

.fhdr{display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;background:rgba(11,14,20,0.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);z-index:5}
.ftitle{font-size:16px;font-weight:700;color:var(--t1)}
.fbody{padding:4px 16px 30px}
.fsec{margin-bottom:18px}
.fstitle{font-size:10px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.fgr{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fg{display:flex;flex-direction:column}.fg.full{grid-column:1/-1}
.flab{font-size:11px;font-weight:600;color:var(--t3);margin-bottom:4px}
.finp{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--t1);font-size:13px}
textarea.finp{resize:vertical;min-height:80px;line-height:1.5}
.facts{display:flex;gap:8px;margin-top:20px;padding-top:14px;border-top:1px solid var(--border)}.facts .btn{flex:1}.facts .btn-g{flex:2}

.add-mth{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}

/* DASHBOARD */
.dash{padding:16px}
.dash-cards{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.dc{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.dc-icon{font-size:20px;margin-bottom:4px}
.dc-val{font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace}
.dc-val.green{color:var(--g)}.dc-val.yellow{color:var(--y)}.dc-val.red{color:var(--r)}.dc-val.blue{color:var(--b)}.dc-val.orange{color:var(--o)}.dc-val.purple{color:var(--p)}
.dc-lab{font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;font-weight:600}
.dash-chart{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px}
.dash-chart h3{font-size:12px;font-weight:700;color:var(--t1);margin-bottom:10px}
.dash-chart canvas{width:100%;height:200px}
.dash-section{margin-bottom:14px}
.dash-section h3{font-size:11px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.top-item{display:flex;align-items:center;gap:8px;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:5px}
.top-rank{font-size:13px;font-weight:800;color:var(--g);font-family:'JetBrains Mono',monospace;width:22px}
.top-info{flex:1;min-width:0}
.top-name{font-size:12px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.top-sub{font-size:10px;color:var(--t4)}

.sov{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:50;display:flex;align-items:flex-end;justify-content:center}.sov.hide{display:none}
.span{background:var(--bg);border:1px solid var(--border);border-radius:22px 22px 0 0;width:100%;max-width:500px;max-height:80vh;overflow-y:auto;padding:20px 20px calc(20px + var(--sb))}
.shandle{width:36px;height:4px;border-radius:2px;background:var(--bg4);margin:0 auto 16px}
.si{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
.tog{width:44px;height:26px;border-radius:13px;background:var(--bg4);cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
.tog.on{background:var(--g)}.togk{width:22px;height:22px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:transform .2s}.tog.on .togk{transform:translateX(18px)}
.imp-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:60;display:flex;align-items:center;justify-content:center;padding:20px}.imp-modal.hide{display:none}
.imp-box{background:var(--bg);border:1px solid var(--border);border-radius:18px;padding:20px;width:100%;max-width:400px;max-height:80vh;overflow-y:auto}
.imp-list{max-height:280px;overflow-y:auto;margin:10px 0}
.imp-item{display:flex;align-items:center;gap:10px;padding:9px;border-radius:10px;border:1px solid var(--border);margin-bottom:5px;cursor:pointer;-webkit-user-select:none}
.imp-item.sel{border-color:var(--g);background:var(--g3)}
.imp-check{width:18px;height:18px;border-radius:5px;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:11px;color:transparent}
.imp-item.sel .imp-check{border-color:var(--g);background:var(--g);color:#fff}

.toast{position:fixed;bottom:calc(70px + var(--sb));left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--g4);color:var(--t1);padding:10px 20px;border-radius:12px;font-size:13px;font-weight:500;z-index:300;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}.toast.show{opacity:1}
</style>
</head>
<body>
<div class="lock" id="lock"><div style="font-size:52px;margin-bottom:18px">üîê</div><h2 id="lT">Entrer le code PIN</h2><p id="lS">Acc√®s prot√©g√©</p><div class="dots" id="dots"></div><div class="numpad" id="numpad"></div><div class="lock-msg" id="lM"></div></div>
<div id="app"></div>
<div class="toast" id="toast"></div>
<script>
(function(){
const LS='crm_master',PK='crm_pin',LK='crm_lk';let db=null;
const OLD_LS=['crm9','crm8','crm7','crm_v5','crm_ls_v5'];
const OLD_IDB=['crm9','crm8','crm7','crm_db'];
function odb(){return new Promise((r,j)=>{const q=indexedDB.open('crm_master',1);q.onupgradeneeded=e=>e.target.result.createObjectStore('d');q.onsuccess=e=>{db=e.target.result;r()};q.onerror=()=>j()})}
function ig(k){return new Promise(r=>{if(!db)return r(null);const t=db.transaction('d','readonly'),q=t.objectStore('d').get(k);q.onsuccess=()=>r(q.result??null);q.onerror=()=>r(null)})}
function ist(k,v){return new Promise(r=>{if(!db)return r();const t=db.transaction('d','readwrite');t.objectStore('d').put(v,k);t.oncomplete=()=>r();t.onerror=()=>r()})}
function tryOldIDB(name){return new Promise(r=>{try{const q=indexedDB.open(name,1);q.onupgradeneeded=e=>{e.target.transaction.abort()};q.onsuccess=e=>{const d=e.target.result;try{const t=d.transaction('d','readonly')||d.transaction('data','readonly');const s=t.objectStore(t.objectStoreNames[0]);const g=s.get('c')||s.get('contacts');g.onsuccess=()=>{d.close();r(g.result||null)};g.onerror=()=>{d.close();r(null)}}catch(err){d.close();r(null)}};q.onerror=()=>r(null)}catch(e){r(null)}})}
async function ld(){try{await odb()}catch(e){}let d=null;
try{d=await ig('c')}catch(e){}
if(!d||!Array.isArray(d)||d.length===0){try{const l=localStorage.getItem(LS);if(l){const p=JSON.parse(l);if(Array.isArray(p)&&p.length>0)d=p}}catch(e){}}
if(!d||!Array.isArray(d)||d.length===0){for(const k of OLD_LS){try{const l=localStorage.getItem(k);if(l){const p=JSON.parse(l);if(Array.isArray(p)&&p.length>0){d=p;break}}}catch(e){}}}
if(!d||!Array.isArray(d)||d.length===0){for(const name of OLD_IDB){const r=await tryOldIDB(name);if(Array.isArray(r)&&r.length>0){d=r;break}}}
if(Array.isArray(d)&&d.length>0){await sv(d)}
return Array.isArray(d)?d:[]}
async function sv(a){try{localStorage.setItem(LS,JSON.stringify(a))}catch(e){}try{await ist('c',a)}catch(e){}}
function gp(){return localStorage.getItem(PK)}function spp(p){localStorage.setItem(PK,p)}function isLk(){return localStorage.getItem(LK)==='1'}function sL(v){localStorage.setItem(LK,v?'1':'0')}

const SECS=[{s:'Identit√©',f:[{k:'prenom',l:'Pr√©nom',i:'‚úèÔ∏è',t:'text'},{k:'nom',l:'Nom',i:'üë§',t:'text'},{k:'telephone',l:'T√©l√©phone',i:'üì±',t:'tel'},{k:'email',l:'Email',i:'‚úâÔ∏è',t:'email'},{k:'username',l:'Username',i:'üîë',t:'text'},{k:'dateNaissance',l:'Date de naissance',i:'üéÇ',t:'date'}]},{s:'Professionnel',f:[{k:'entreprise',l:'Entreprise',i:'üè¢',t:'text'},{k:'poste',l:'Poste / Fonction',i:'üíº',t:'text'},{k:'villeTravail',l:'Ville de travail',i:'üèôÔ∏è',t:'text'},{k:'salaire',l:'Salaire',i:'üí∞',t:'number',sx:'‚Ç¨'},{k:'pourcentage',l:'% Commission',i:'üìä',t:'number',sx:'%'}]},{s:'Autres',f:[{k:'adresse',l:'Adresse',i:'üìç',t:'text',fu:1},{k:'tags',l:'Tags (virgule)',i:'üè∑Ô∏è',t:'text',fu:1,ph:'VIP, prospect, partenaire'},{k:'dernierContact',l:'Dernier contact',i:'üìÖ',t:'date'},{k:'notes',l:'Notes priv√©es',i:'üìù',t:'textarea',fu:1}]}];
const AK=SECS.flatMap(s=>s.f.map(f=>f.k));
const MO=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];
const CURS=['EUR','USD','TND','Cr√©dit'];
const CUR_CLS={EUR:'cur-eur',USD:'cur-usd',TND:'cur-tnd','Cr√©dit':'cur-credit'};
const CUR_SYM={EUR:'‚Ç¨',USD:'$',TND:'TND','Cr√©dit':'CR'};
const CUR_CLR={EUR:'var(--b)',USD:'var(--g)',TND:'var(--o)','Cr√©dit':'var(--p)'};

let C=[],tab='list',vw='list',sid=null,ed=null,sq='',so='nom',ft='',dc=null,stg=false,impModal=false,impData=[],impSel=new Set();
let pb='',pm='unlock',pf='',pe='',pl=false;
let mM='',mA='';
let iDesc='',iAmt='',iCur='EUR',iPaid=false;

async function init(){C=await ld();if(isLk()&&gp()){pl=true}else document.getElementById('lock').classList.add('out');rl();ra()}

function rl(){
  const el=document.getElementById('lock');if(!pl){el.classList.add('out');return}el.classList.remove('out');
  let t='Entrer le code PIN',s='Acc√®s prot√©g√©';if(pm==='setup'){t='Cr√©er un code PIN';s='4 chiffres'}if(pm==='confirm'){t='Confirmer le PIN';s='Retapez le code'}
  document.getElementById('lT').textContent=t;document.getElementById('lS').textContent=s;document.getElementById('lM').textContent=pe;
  const d=document.getElementById('dots');d.innerHTML='';for(let i=0;i<4;i++){const x=document.createElement('div');x.className='dot';if(pe)x.classList.add('err');else if(i<pb.length)x.classList.add('on');d.appendChild(x)}
  const pad=document.getElementById('numpad');pad.innerHTML='';
  [1,2,3,4,5,6,7,8,9,'c',0,'d'].forEach(n=>{const b=document.createElement('div');
    if(n==='c'){b.className='nk fn';b.textContent='Annuler';b.onclick=()=>{if(pm!=='unlock'){pl=false;pb='';pe='';pm='unlock';rl();ra()}}}
    else if(n==='d'){b.className='nk fn';b.textContent='‚å´';b.onclick=()=>{pb=pb.slice(0,-1);pe='';rl()}}
    else{b.className='nk';b.textContent=n;b.onclick=()=>{if(pb.length<4){pb+=String(n);pe='';rl();if(pb.length===4)setTimeout(pProc,180)}}}
    pad.appendChild(b)})
}
function pProc(){
  if(pm==='unlock'){if(pb===gp()){pl=false;pb='';pe='';rl();ra()}else{pe='Code incorrect';pb='';rl();document.getElementById('dots')?.classList.add('shake')}}
  else if(pm==='setup'){pf=pb;pb='';pm='confirm';rl()}
  else if(pm==='confirm'){if(pb===pf){spp(pb);sL(true);pl=false;pb='';pe='';pm='unlock';tt('‚úÖ PIN activ√©');rl();ra()}else{pe='Codes diff√©rents';pb='';pm='setup';pf='';rl();document.getElementById('dots')?.classList.add('shake')}}
}
function tt(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}

function Q(s,fn){const e=document.querySelector(s);if(e)fn(e)}
function E(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function mkN(){const c={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),dateAjout:new Date().toISOString().split('T')[0],fav:false,monthly:[],invoices:[]};AK.forEach(k=>{if(!c[k])c[k]=''});return c}
function fmt(n){return Math.round(n).toLocaleString('fr')}
function fmtM(d){if(!d)return'?';const p=d.split('-');if(p.length>=2)return MO[parseInt(p[1])-1]+' '+p[0].slice(2);return d}
function pendByCur(c){const r={};(c.invoices||[]).filter(i=>!i.paid).forEach(i=>{const cur=i.currency||'EUR';r[cur]=(r[cur]||0)+Number(i.amount||0)});return r}
function totalPending(c){return(c.invoices||[]).filter(i=>!i.paid).reduce((s,i)=>s+Number(i.amount||0),0)}
function totalCA(c){return(c.monthly||[]).reduce((s,m)=>s+Number(m.amount||0),0)}

function ra(){
  const a=document.getElementById('app');let h='';
  h+=`<div class="hdr"><div class="hdr-l"><span style="font-size:16px">üîí</span><span class="brand">My<span>CRM</span></span><span class="cnt">${C.length}</span></div><div style="display:flex;gap:6px;align-items:center">${tab==='list'&&vw==='list'?`<button class="btn btn-s" id="sB" style="padding:5px 9px;font-size:13px">‚öôÔ∏è</button><button class="btn btn-g" id="aB" style="padding:7px 12px">+ Nouveau</button>`:''}</div></div>`;
  h+=rSettings()+rImpModal();
  if(tab==='list'&&vw==='list')h+=rList();
  else if(tab==='list'&&vw==='detail')h+=rDetail();
  else if(tab==='list'&&vw==='form')h+=rForm();
  else if(tab==='dash')h+=rDash();
  h+=`<div class="nav"><div class="nav-item ${tab==='list'?'act':''}" data-tab="list"><div class="ni">üë•</div>Contacts</div><div class="nav-item ${tab==='dash'?'act':''}" data-tab="dash"><div class="ni">üìä</div>Dashboard</div></div>`;
  a.innerHTML=h;bindAll();
  if(tab==='dash')drawDashChart();
  if(vw==='detail'&&sid)drawMini();
}

// LIST
function gf(){const q=sq.toLowerCase();return C.filter(c=>{const m=!q||Object.values(c).some(v=>typeof v==='string'&&v.toLowerCase().includes(q));const t=!ft||(c.tags&&c.tags.toLowerCase().includes(ft.toLowerCase()));return m&&t}).sort((a,b)=>{if(so==='fav')return(b.fav?1:0)-(a.fav?1:0);if(so==='debt')return totalPending(b)-totalPending(a);if(so==='ca')return totalCA(b)-totalCA(a);return(a[so]||'').toLowerCase().localeCompare((b[so]||'').toLowerCase())})}
function aTags(){return[...new Set(C.flatMap(c=>c.tags?c.tags.split(',').map(t=>t.trim()).filter(Boolean):[]))]}

function rList(){
  const f=gf(),tg=aTags();let items='';
  if(!f.length){items=C.length?'<div class="empty"><div class="ei">üîç</div>Aucun r√©sultat</div>':'<div class="empty"><div class="ei">üìã</div><div>Aucun contact</div><div style="font-size:12px;color:var(--t4);margin-top:4px">+ Nouveau ou importe depuis Telegram</div></div>'}
  else{items=f.map(c=>{
    const pend=pendByCur(c);const pKeys=Object.keys(pend);
    const badges=pKeys.map(cur=>`<div class="debt-badge debt-r">${fmt(pend[cur])} ${CUR_SYM[cur]||cur}</div>`).join('');
    const noPend=pKeys.length===0&&(c.invoices||[]).length>0;
    const ca=totalCA(c);
    return`<div class="cc anim" data-id="${c.id}"><div class="av">${(c.prenom?.[0]||c.nom?.[0]||'?').toUpperCase()}</div><div class="ci"><div class="cn">${c.fav?'‚≠ê ':''}${E(c.prenom)} ${E(c.nom)}</div><div class="cs">${E([c.entreprise,c.villeTravail].filter(Boolean).join(' ¬∑ '))||'‚Äî'}</div></div><div class="cc-right">${ca?`<div class="pb">${fmt(ca)} ‚Ç¨</div>`:''}${c.pourcentage?`<div class="pb" style="background:var(--b2);color:var(--b)">${E(c.pourcentage)}%</div>`:''}${badges}${noPend?'<div class="debt-badge debt-g">‚úÖ Sold√©</div>':''}</div></div>`}).join('')}
  const to=tg.map(t=>`<option value="${E(t)}" ${ft===t?'selected':''}>${E(t)}</option>`).join('');
  return`<div class="vw anim"><div class="sbar"><input class="sinp" id="si" placeholder="üîç  Rechercher..." value="${E(sq)}"></div><div class="flts"><select class="fsel" id="ss"><option value="nom" ${so==='nom'?'selected':''}>Nom</option><option value="fav" ${so==='fav'?'selected':''}>‚≠ê Favoris</option><option value="ca" ${so==='ca'?'selected':''}>üìà Chiffre d'affaires</option><option value="debt" ${so==='debt'?'selected':''}>üí∏ Dettes</option><option value="entreprise" ${so==='entreprise'?'selected':''}>Entreprise</option></select>${tg.length?`<select class="fsel" id="ts"><option value="">Tous</option>${to}</select>`:''}</div><div class="clist">${items}</div></div>`;
}

// DETAIL
function rDetail(){
  const c=C.find(x=>x.id===sid);if(!c)return'';
  const tgs=c.tags?c.tags.split(',').map(t=>t.trim()).filter(Boolean):[];
  const fields=SECS.flatMap(s=>s.f).filter(f=>f.k!=='notes'&&f.k!=='tags'&&c[f.k]).map(f=>{let v=E(c[f.k]);if(f.sx)v+=f.sx;return`<div class="fc"><div class="fi">${f.i}</div><div><div class="fl">${f.l}</div><div class="fv">${v}</div></div></div>`}).join('');
  
  // Invoices
  const invs=(c.invoices||[]);
  const pend=pendByCur(c);const pKeys=Object.keys(pend);
  const totH=pKeys.length?pKeys.map(cur=>`<div class="inv-total-chip"><div class="inv-total-label">D√ª en ${cur}</div><div class="inv-total-val">${fmt(pend[cur])} ${CUR_SYM[cur]||cur}</div></div>`).join(''):`<div class="inv-total-chip"><div class="inv-total-val zero">‚úÖ Aucune dette</div></div>`;
  const invH=invs.map((inv,i)=>`<div class="inv-card"><div class="inv-left"><div class="inv-desc">${E(inv.desc||'Sans description')}</div><div class="inv-date">${E(inv.date||'')}</div></div><div class="inv-right"><div class="inv-amt" style="color:${inv.paid?'var(--g)':'var(--r)'}">${fmt(inv.amount)}</div><div class="inv-cur ${CUR_CLS[inv.currency]||'cur-eur'}">${inv.currency||'EUR'}</div><div class="inv-status ${inv.paid?'inv-paid':'inv-pending'}" data-ti="${i}">${inv.paid?'‚úÖ Pay√©':'‚è≥ D√ª'}</div><div class="inv-del" data-di="${i}">üóëÔ∏è</div></div></div>`).join('');
  
  // Monthly CA
  const monthly=(c.monthly||[]).sort((a,b)=>a.date>b.date?-1:1);
  const totalCa=monthly.reduce((s,m)=>s+Number(m.amount||0),0);
  const avgCa=monthly.length?totalCa/monthly.length:0;
  const mthH=monthly.map((m,i)=>`<div class="mth-card"><div class="mth-month">${fmtM(m.date)}</div><div style="display:flex;align-items:center;gap:8px"><div class="mth-amt">${Number(m.amount).toLocaleString('fr')} ‚Ç¨</div><div class="inv-del" data-mi="${i}">üóëÔ∏è</div></div></div>`).join('');

  const delH=dc===c.id?`<div style="display:flex;gap:4px;align-items:center"><span style="color:var(--r);font-size:11px">S√ªr?</span><button class="btn btn-r" id="cY" style="padding:4px 10px;font-size:11px">Oui</button><button class="btn btn-o" id="cN" style="padding:4px 10px;font-size:11px">Non</button></div>`:`<button class="btn btn-r" id="dB" style="padding:5px 8px;font-size:12px">üóëÔ∏è</button>`;

  return`<div class="vw anim">
    <div class="dhdr"><button class="btn btn-o" id="bB" style="padding:5px 11px;font-size:12px">‚Üê Retour</button><div class="dacts"><button style="font-size:18px;background:none;border:none;cursor:pointer;padding:4px" id="togFav">${c.fav?'‚≠ê':'‚òÜ'}</button><button class="btn btn-s" id="eB" style="padding:5px 11px;font-size:12px">‚úèÔ∏è</button>${delH}</div></div>
    <div class="pcard"><div class="av lg">${(c.prenom?.[0]||c.nom?.[0]||'?').toUpperCase()}</div><div><div class="pname">${c.fav?'‚≠ê ':''}${E(c.prenom)} ${E(c.nom)}</div><div class="prole">${E([c.poste,c.entreprise].filter(Boolean).join(' ‚Äî '))||'‚Äî'}</div>${tgs.length?`<div class="trow">${tgs.map(t=>`<span class="tg">${E(t)}</span>`).join('')}</div>`:''}</div></div>
    <div class="fgrid">${fields}</div>
    ${c.notes?`<div class="nbox"><div style="font-size:12px;font-weight:700;color:var(--t1);margin-bottom:5px">üìù Notes</div><div style="font-size:12px;color:var(--t3);white-space:pre-wrap;line-height:1.6">${E(c.notes)}</div></div>`:''}
    
    <div class="sec"><div class="sec-t"><span>üßæ Factures / Dettes (${invs.length})</span></div>
      <div class="inv-totals">${totH}</div>
      ${invH}
      <div class="add-inv"><div class="add-inv-title">+ Ajouter une facture</div>
        <div class="add-row"><div class="fg w1"><label class="flab">Description</label><input class="finp" id="iD" value="${E(iDesc)}" placeholder="Ex: Commission janvier"></div><div class="fg w2"><label class="flab">Montant</label><input class="finp" type="number" id="iA" value="${iAmt}" placeholder="0"></div></div>
        <div class="add-row"><div class="fg w2"><label class="flab">Devise</label><select class="finp" id="iC">${CURS.map(c=>`<option value="${c}" ${iCur===c?'selected':''}>${c}</option>`).join('')}</select></div>
          <div class="fg w2"><label class="flab">Statut</label><div class="paid-toggle"><div class="pt-opt ${!iPaid?'act-r':''}" id="iPR">‚è≥ D√ª</div><div class="pt-opt ${iPaid?'act-g':''}" id="iPG">‚úÖ Pay√©</div></div></div>
          <div class="fg" style="justify-content:flex-end"><button class="btn btn-g" id="addI" style="padding:9px 16px">+</button></div>
        </div>
      </div>
    </div>

    ${monthly.length?`<div class="chart-box"><div style="font-size:12px;font-weight:700;color:var(--t1);margin-bottom:8px">üìà √âvolution du CA</div><canvas id="miniC" height="140"></canvas></div>`:''}
    
    <div class="sec"><div class="sec-t"><span>üìà Chiffre d'Affaires (${monthly.length} mois)</span></div>
      ${monthly.length?`<div class="mth-total"><div><div class="mth-total-label">CA Total</div><div class="mth-total-val">${fmt(totalCa)} ‚Ç¨</div></div><div><div class="mth-avg">Moy: ${fmt(avgCa)} ‚Ç¨ / mois</div></div></div>`:''}
      ${mthH}
      <div class="add-mth"><div style="font-size:11px;font-weight:700;color:var(--y);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">+ Ajouter un mois</div>
        <div style="display:flex;gap:8px;margin-bottom:10px"><div class="fg" style="flex:1"><label class="flab">Mois</label><input class="finp" type="month" id="mMi" value="${mM}"></div><div class="fg" style="flex:1"><label class="flab">Chiffre d'affaires ‚Ç¨</label><input class="finp" type="number" id="mAi" value="${mA}" placeholder="0"></div></div>
        <div style="display:flex;justify-content:flex-end"><button class="btn btn-g" id="addM" style="padding:8px 20px">üìà Ajouter</button></div>
      </div>
    </div>
  </div>`;
}

// FORM
function rForm(){
  const c=ed,nw=!C.find(x=>x.id===c.id);
  const secs=SECS.map(s=>{const fs=s.f.map(f=>{const v=E(c[f.k]||''),fc=f.fu?'fg full':'fg';if(f.t==='textarea')return`<div class="${fc}"><label class="flab">${f.i} ${f.l}</label><textarea class="finp" data-f="${f.k}" placeholder="${f.ph||''}">${v}</textarea></div>`;return`<div class="${fc}"><label class="flab">${f.i} ${f.l}</label><input class="finp" type="${f.t}" data-f="${f.k}" value="${v}" placeholder="${f.ph||''}"></div>`}).join('');return`<div class="fsec"><div class="fstitle">${s.s}</div><div class="fgr">${fs}</div></div>`}).join('');
  return`<div class="vw anim"><div class="fhdr"><button class="btn btn-o" id="fBk" style="padding:5px 11px;font-size:12px">‚Üê Annuler</button><span class="ftitle">${nw?'Nouveau contact':'Modifier'}</span></div><div class="fbody">${secs}<div class="facts"><button class="btn btn-o" id="fCa">Annuler</button><button class="btn btn-g" id="fSv">üíæ Enregistrer</button></div></div></div>`;
}

// DASHBOARD
function rDash(){
  const totalC=C.length,favC=C.filter(c=>c.fav).length;
  // Pending invoices
  const allInv=C.flatMap(c=>(c.invoices||[]).map(i=>({...i,contact:c})));
  const pendBC={};allInv.filter(i=>!i.paid).forEach(i=>{const c=i.currency||'EUR';pendBC[c]=(pendBC[c]||0)+Number(i.amount||0)});
  // Total CA
  const allM=C.flatMap(c=>(c.monthly||[]).map(m=>({...m,contact:c})));
  const totalCaAll=allM.reduce((s,m)=>s+Number(m.amount||0),0);
  
  const pendCards=Object.keys(pendBC).map(cur=>`<div class="dc"><div class="dc-icon">üßæ</div><div class="dc-val red">${fmt(pendBC[cur])}</div><div class="dc-lab">D√ª ${cur}</div></div>`).join('');

  // Top by CA
  const byCA=C.map(c=>({c,ca:totalCA(c)})).filter(d=>d.ca>0).sort((a,b)=>b.ca-a.ca).slice(0,5);
  const caHtml=byCA.map((d,i)=>`<div class="top-item"><div class="top-rank">#${i+1}</div><div class="top-info"><div class="top-name">${E(d.c.prenom)} ${E(d.c.nom)}</div><div class="top-sub">${E(d.c.entreprise)||'‚Äî'}</div></div><div style="font-size:14px;font-weight:700;color:var(--y);font-family:'JetBrains Mono',monospace">${fmt(d.ca)} ‚Ç¨</div></div>`).join('');

  // Top debtors
  const debtors=C.map(c=>({c,debts:pendByCur(c)})).filter(d=>Object.keys(d.debts).length>0).sort((a,b)=>totalPending(b.c)-totalPending(a.c)).slice(0,5);
  const debtHtml=debtors.map((d,i)=>{
    const chips=Object.keys(d.debts).map(cur=>`<span style="color:${CUR_CLR[cur]};font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace">${fmt(d.debts[cur])} ${CUR_SYM[cur]}</span>`).join(' + ');
    return`<div class="top-item"><div class="top-rank">#${i+1}</div><div class="top-info"><div class="top-name">${E(d.c.prenom)} ${E(d.c.nom)}</div><div class="top-sub">${E(d.c.entreprise)||'‚Äî'}</div></div><div>${chips}</div></div>`}).join('');

  const byMonth={};allM.forEach(m=>{const k=m.date||'?';byMonth[k]=(byMonth[k]||0)+Number(m.amount||0)});
  const hasChart=Object.keys(byMonth).length>0;

  return`<div class="vw anim"><div class="dash">
    <div class="dash-cards">
      <div class="dc"><div class="dc-icon">üë•</div><div class="dc-val green">${totalC}</div><div class="dc-lab">Contacts</div></div>
      <div class="dc"><div class="dc-icon">‚≠ê</div><div class="dc-val yellow">${favC}</div><div class="dc-lab">Favoris</div></div>
      <div class="dc"><div class="dc-icon">üìà</div><div class="dc-val yellow">${fmt(totalCaAll)} ‚Ç¨</div><div class="dc-lab">CA Total</div></div>
      <div class="dc"><div class="dc-icon">üìä</div><div class="dc-val blue">${allM.length?fmt(totalCaAll/new Set(allM.map(m=>m.date)).size):0} ‚Ç¨</div><div class="dc-lab">CA Moy/Mois</div></div>
      ${pendCards}
    </div>
    ${hasChart?`<div class="dash-chart"><h3>üìà Chiffre d'Affaires Global</h3><canvas id="dashC" height="200"></canvas></div>`:''}
    ${byCA.length?`<div class="dash-section"><h3>üèÜ Top CA</h3>${caHtml}</div>`:''}
    ${debtors.length?`<div class="dash-section"><h3>üßæ Top D√©biteurs</h3>${debtHtml}</div>`:''}
  </div></div>`;
}

// SETTINGS
function rSettings(){
  const hp=!!gp(),lo=isLk();
  return`<div class="sov ${stg?'':'hide'}" id="sO"><div class="span"><div class="shandle"></div><div style="font-size:15px;font-weight:700;color:var(--t1);margin-bottom:14px">‚öôÔ∏è Param√®tres</div>
    <div class="si"><div><div style="font-size:13px;color:var(--t2)">üîí Verrouillage PIN</div><div style="font-size:11px;color:var(--t4)">${hp?'PIN configur√©':'Aucun PIN'}</div></div><div class="tog ${lo&&hp?'on':''}" id="tL"><div class="togk"></div></div></div>
    ${hp?'<button class="btn btn-s" id="chP" style="width:100%;margin-top:8px;padding:10px">Changer le PIN</button>':''}
    <button class="btn btn-s" id="impTg" style="width:100%;margin-top:8px;padding:10px">üì± Importer depuis Telegram</button>
    <button class="btn btn-s" id="expB" style="width:100%;margin-top:8px;padding:10px">üì§ Exporter backup</button>
    <label class="btn btn-s" style="width:100%;margin-top:8px;padding:10px;display:block;text-align:center;cursor:pointer">üì• Importer backup<input type="file" accept=".json" id="impF" style="display:none"></label>
    <button class="btn btn-r" id="nukB" style="width:100%;margin-top:16px;padding:10px">üóëÔ∏è Tout supprimer</button>
  </div></div>`;
}

function rImpModal(){
  if(!impModal)return'<div class="imp-modal hide"></div>';
  const items=impData.map((c,i)=>`<div class="imp-item ${impSel.has(i)?'sel':''}" data-ii="${i}"><div class="imp-check">${impSel.has(i)?'‚úì':''}</div><div><div style="font-size:13px;font-weight:600;color:var(--t1)">${E(c.first_name||'')} ${E(c.last_name||'')}</div><div style="font-size:11px;color:var(--t4)">${E(c.phone_number||c.username||'')}</div></div></div>`).join('');
  return`<div class="imp-modal" id="impMod"><div class="imp-box"><h3 style="font-size:16px;font-weight:700;color:var(--t1);margin-bottom:12px">üì± Import Telegram</h3>
    <div style="font-size:11px;color:var(--t3);margin-bottom:10px;line-height:1.5"><b>1.</b> Telegram Desktop ‚Üí Settings ‚Üí Advanced ‚Üí Export<br><b>2.</b> Coche "Contacts", format JSON<br><b>3.</b> Upload result.json ici</div>
    <label class="btn btn-s" style="display:block;text-align:center;cursor:pointer;padding:10px">üìÇ Charger fichier<input type="file" accept=".json" id="tgF" style="display:none"></label>
    ${impData.length?`<div style="margin-top:8px;font-size:11px;color:var(--t3)">${impData.length} trouv√©s</div><div style="margin:6px 0"><button class="btn btn-s" id="selA" style="padding:4px 10px;font-size:11px">Tout s√©lectionner</button></div><div class="imp-list">${items}</div><button class="btn btn-g" id="doImp" style="width:100%;margin-top:8px;padding:10px">Importer ${impSel.size} contact(s)</button>`:''}
    <button class="btn btn-o" id="clImp" style="width:100%;margin-top:8px;padding:10px">Fermer</button>
  </div></div>`;
}

// CHARTS
function drawDashChart(){
  const allM=C.flatMap(c=>(c.monthly||[]));
  const byM={};allM.forEach(m=>{const k=m.date||'?';byM[k]=(byM[k]||0)+Number(m.amount||0)});
  const ks=Object.keys(byM).sort();if(!ks.length)return;
  const cv=document.getElementById('dashC');if(!cv)return;
  const ctx=cv.getContext('2d');const W=cv.parentElement.clientWidth-28;cv.width=W*2;cv.height=400;ctx.scale(2,2);
  const h=160,pad=35,maxV=Math.max(...ks.map(k=>byM[k]),1),gap=(W-pad*2)/ks.length,bw=Math.min(30,gap*.65);
  for(let i=0;i<=4;i++){const y=pad+h-h*(i/4);ctx.strokeStyle='#1c2733';ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-5,y);ctx.stroke();ctx.fillStyle='#4e5d6e';ctx.font='8px JetBrains Mono';ctx.textAlign='right';ctx.fillText(fmt(maxV*i/4),pad-4,y+3)}
  ks.forEach((k,i)=>{const x=pad+gap*i+gap/2,bh=byM[k]/maxV*h;
    const gr=ctx.createLinearGradient(0,pad+h-bh,0,pad+h);gr.addColorStop(0,'#f1c40f');gr.addColorStop(1,'#e67e22');
    ctx.fillStyle=gr;ctx.beginPath();ctx.roundRect(x-bw/2,pad+h-bh,bw,bh,4);ctx.fill();
    ctx.fillStyle='#7e8d9e';ctx.font='8px Inter';ctx.textAlign='center';ctx.fillText(fmtM(k),x,pad+h+12);
    ctx.fillStyle='#f0f2f5';ctx.font='bold 9px JetBrains Mono';ctx.fillText(fmt(byM[k]),x,pad+h-bh-5);
  });
}

function drawMini(){
  const c=C.find(x=>x.id===sid);if(!c)return;
  const monthly=(c.monthly||[]).sort((a,b)=>a.date>b.date?1:-1);if(!monthly.length)return;
  const cv=document.getElementById('miniC');if(!cv)return;
  const ctx=cv.getContext('2d');const W=cv.parentElement.clientWidth-28;cv.width=W*2;cv.height=280;ctx.scale(2,2);
  const h=100,pad=30,maxV=Math.max(...monthly.map(m=>Number(m.amount||0)),1),gap=(W-pad*2)/Math.max(monthly.length-1,1);
  for(let i=0;i<=3;i++){const y=pad+h-h*(i/3);ctx.strokeStyle='#1c2733';ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-5,y);ctx.stroke();ctx.fillStyle='#4e5d6e';ctx.font='8px JetBrains Mono';ctx.textAlign='right';ctx.fillText(fmt(maxV*i/3),pad-4,y+3)}
  // Area
  ctx.beginPath();ctx.moveTo(pad,pad+h);
  monthly.forEach((m,i)=>{const x=pad+gap*i,y=pad+h-Number(m.amount||0)/maxV*h;ctx.lineTo(x,y)});
  ctx.lineTo(pad+gap*(monthly.length-1),pad+h);ctx.closePath();
  const gr=ctx.createLinearGradient(0,pad,0,pad+h);gr.addColorStop(0,'rgba(241,196,15,0.2)');gr.addColorStop(1,'rgba(241,196,15,0)');ctx.fillStyle=gr;ctx.fill();
  // Line
  ctx.beginPath();monthly.forEach((m,i)=>{const x=pad+gap*i,y=pad+h-Number(m.amount||0)/maxV*h;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});ctx.strokeStyle='#f1c40f';ctx.lineWidth=2.5;ctx.stroke();
  // Dots
  monthly.forEach((m,i)=>{const x=pad+gap*i,y=pad+h-Number(m.amount||0)/maxV*h;
    ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fillStyle='#f1c40f';ctx.fill();ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    ctx.fillStyle='#7e8d9e';ctx.font='8px Inter';ctx.textAlign='center';ctx.fillText(fmtM(m.date),x,pad+h+12);
    ctx.fillStyle='#f0f2f5';ctx.font='bold 8px JetBrains Mono';ctx.fillText(fmt(m.amount),x,y-8);
  });
}

// BINDINGS
function bindAll(){
  document.querySelectorAll('.nav-item').forEach(n=>n.onclick=()=>{tab=n.dataset.tab;vw=tab==='dash'?'dash':'list';sid=null;ra()});
  Q('#sB',e=>e.onclick=()=>{stg=true;ra()});
  Q('#aB',e=>e.onclick=()=>{ed=mkN();vw='form';ra()});
  Q('#sO',e=>e.onclick=v=>{if(v.target===e){stg=false;ra()}});
  Q('#tL',e=>e.onclick=()=>{if(isLk()&&gp()){sL(false);ra()}else if(gp()){sL(true);ra()}else{stg=false;pl=true;pm='setup';pb='';pe='';rl()}});
  Q('#chP',e=>e.onclick=()=>{stg=false;pl=true;pm='setup';pb='';pe='';rl()});
  Q('#impTg',e=>e.onclick=()=>{stg=false;impModal=true;impData=[];impSel=new Set();ra()});
  Q('#expB',e=>e.onclick=()=>{const b=new Blob([JSON.stringify(C,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`crm_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(u);tt('üì§ Export√©')});
  Q('#impF',e=>e.onchange=ev=>{const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=async e=>{try{const d=JSON.parse(e.target.result);if(Array.isArray(d)){let n=0;d.forEach(i=>{if(!C.find(c=>c.id===i.id)){C.push(i);n++}});await sv(C);stg=false;tt(`üì• ${n} import√©(s)`);ra()}}catch(err){tt('‚ùå Invalide')}};r.readAsText(f);ev.target.value=''});
  Q('#nukB',e=>e.onclick=()=>{if(confirm('Supprimer TOUS les contacts ?')){C=[];sv([]);sid=null;vw='list';stg=false;tt('Supprim√©');ra()}});
  // Import
  Q('#tgF',e=>e.onchange=ev=>{const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);let ct=[];if(d.contacts&&d.contacts.list)ct=d.contacts.list;else if(Array.isArray(d))ct=d;else if(d.contacts&&Array.isArray(d.contacts))ct=d.contacts;impData=ct.filter(c=>c.first_name||c.last_name||c.phone_number);impSel=new Set();ra()}catch(err){tt('‚ùå Format non reconnu')}};r.readAsText(f);ev.target.value=''});
  Q('#clImp',e=>e.onclick=()=>{impModal=false;ra()});
  Q('#impMod',e=>e.onclick=v=>{if(v.target===e){impModal=false;ra()}});
  Q('#selA',e=>e.onclick=()=>{impSel=impSel.size===impData.length?new Set():new Set(impData.map((_,i)=>i));ra()});
  document.querySelectorAll('.imp-item').forEach(el=>el.onclick=()=>{const i=parseInt(el.dataset.ii);impSel.has(i)?impSel.delete(i):impSel.add(i);ra()});
  Q('#doImp',e=>e.onclick=async()=>{let n=0;impSel.forEach(i=>{const tc=impData[i];if(!tc)return;if(!C.find(c=>c.telephone===tc.phone_number&&tc.phone_number)){const nc=mkN();nc.prenom=tc.first_name||'';nc.nom=tc.last_name||'';nc.telephone=tc.phone_number||'';nc.username=tc.username||'';C.push(nc);n++}});await sv(C);impModal=false;tt(`üì± ${n} import√©(s)`);ra()});
  // Search
  Q('#si',e=>{e.oninput=()=>{sq=e.value;ra();const el=document.getElementById('si');el?.focus();el.selectionStart=el.selectionEnd=sq.length}});
  Q('#ss',e=>e.onchange=()=>{so=e.value;ra()});Q('#ts',e=>e.onchange=()=>{ft=e.value;ra()});
  // Cards
  document.querySelectorAll('.cc').forEach(c=>c.onclick=()=>{sid=c.dataset.id;vw='detail';mM='';mA='';iDesc='';iAmt='';iCur='EUR';iPaid=false;ra()});
  // Detail
  Q('#bB',e=>e.onclick=()=>{sid=null;dc=null;vw='list';ra()});
  Q('#togFav',e=>e.onclick=async()=>{const c=C.find(x=>x.id===sid);if(c){c.fav=!c.fav;await sv(C);ra()}});
  Q('#eB',e=>e.onclick=()=>{const c=C.find(x=>x.id===sid);if(c){ed={...c,monthly:[...(c.monthly||[])],invoices:[...(c.invoices||[])]};vw='form';ra()}});
  Q('#dB',e=>e.onclick=()=>{dc=sid;ra()});
  Q('#cY',e=>e.onclick=async()=>{C=C.filter(c=>c.id!==sid);await sv(C);sid=null;dc=null;vw='list';tt('Supprim√©');ra()});
  Q('#cN',e=>e.onclick=()=>{dc=null;ra()});
  // Invoices
  Q('#iD',e=>e.oninput=()=>iDesc=e.value);Q('#iA',e=>e.oninput=()=>iAmt=e.value);Q('#iC',e=>e.onchange=()=>iCur=e.value);
  Q('#iPR',e=>e.onclick=()=>{iPaid=false;ra()});Q('#iPG',e=>e.onclick=()=>{iPaid=true;ra()});
  Q('#addI',e=>e.onclick=async()=>{
    if(!iAmt)return;const c=C.find(x=>x.id===sid);if(!c)return;
    if(!c.invoices)c.invoices=[];
    c.invoices.push({desc:iDesc||'Facture',amount:Number(iAmt),currency:iCur,paid:iPaid,date:new Date().toISOString().split('T')[0]});
    await sv(C);iDesc='';iAmt='';iPaid=false;tt('üßæ Ajout√©e');ra()
  });
  document.querySelectorAll('.inv-status').forEach(el=>el.onclick=async()=>{const i=parseInt(el.dataset.ti);const c=C.find(x=>x.id===sid);if(c&&c.invoices&&c.invoices[i]!==undefined){c.invoices[i].paid=!c.invoices[i].paid;await sv(C);ra()}});
  document.querySelectorAll('[data-di]').forEach(el=>el.onclick=async()=>{const i=parseInt(el.dataset.di);const c=C.find(x=>x.id===sid);if(c&&c.invoices){c.invoices.splice(i,1);await sv(C);ra()}});
  // Monthly CA
  Q('#mMi',e=>e.oninput=()=>mM=e.value);Q('#mAi',e=>e.oninput=()=>mA=e.value);
  Q('#addM',e=>e.onclick=async()=>{
    if(!mM||!mA)return;const c=C.find(x=>x.id===sid);if(!c)return;
    if(!c.monthly)c.monthly=[];
    c.monthly.push({date:mM,amount:Number(mA)});
    await sv(C);mM='';mA='';tt('üìà CA ajout√©');ra()
  });
  document.querySelectorAll('[data-mi]').forEach(el=>el.onclick=async()=>{const i=parseInt(el.dataset.mi);const c=C.find(x=>x.id===sid);if(c&&c.monthly){c.monthly.splice(i,1);await sv(C);ra()}});
  // Form
  const goB=()=>{ed=null;vw=sid?'detail':'list';ra()};
  Q('#fBk',e=>e.onclick=goB);Q('#fCa',e=>e.onclick=goB);
  document.querySelectorAll('.finp[data-f]').forEach(i=>i.oninput=()=>{if(ed)ed[i.dataset.f]=i.value});
  Q('#fSv',e=>e.onclick=async()=>{if(!ed||(!ed.nom&&!ed.prenom))return;const x=C.findIndex(c=>c.id===ed.id);if(x>=0){ed.monthly=C[x].monthly||[];ed.invoices=C[x].invoices||[];C[x]={...ed}}else{ed.monthly=[];ed.invoices=[];C.push({...ed})}await sv(C);sid=ed.id;ed=null;vw='detail';tt('‚úÖ Enregistr√©');ra()});
}

init();
})();
</script>
</body>
</html>
