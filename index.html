<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MyCRM">
<meta name="theme-color" content="#0b0e14">
<title>Mon CRM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--bg:#0b0e14;--bg2:#111820;--bg3:#182028;--bg4:#1f2a34;--bg5:#263240;--border:#1c2733;--border2:#2a3a4a;--t1:#f0f2f5;--t2:#c4ccd6;--t3:#7e8d9e;--t4:#4e5d6e;--g:#2ecc71;--g2:#27ae60;--g3:rgba(46,204,113,0.10);--g4:rgba(46,204,113,0.20);--y:#f1c40f;--y2:rgba(241,196,15,0.12);--r:#e74c3c;--r2:rgba(231,76,60,0.10);--r3:rgba(231,76,60,0.20);--b:#3498db;--b2:rgba(52,152,219,0.12);--o:#e67e22;--o2:rgba(230,126,34,0.12);--p:#9b59b6;--p2:rgba(155,89,182,0.12);--st:env(safe-area-inset-top);--sb:env(safe-area-inset-bottom)}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--t2);font-family:'Inter',sans-serif;font-size:14px}
input,textarea,select,button{font-family:inherit;font-size:inherit}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--g)!important;box-shadow:0 0 0 3px var(--g3)!important}
input::placeholder,textarea::placeholder{color:var(--t4)}
select{-webkit-appearance:none}::-webkit-scrollbar{width:0;height:0}
.lock{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;padding:20px;transition:opacity .3s}.lock.out{opacity:0;pointer-events:none}
.lock h2{font-size:18px;font-weight:700;color:var(--t1);margin-bottom:4px}.lock p{font-size:13px;color:var(--t3);margin-bottom:20px;text-align:center}
.pw-wrap{position:relative;width:250px;margin-bottom:18px}
.pw-inp{width:100%;background:var(--bg2);border:2px solid var(--border);border-radius:14px;padding:14px 50px 14px 16px;color:var(--t1);font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;letter-spacing:3px;text-align:center;-webkit-text-security:disc}
.pw-inp::placeholder{letter-spacing:0;font-size:12px;font-weight:400;-webkit-text-security:none}
.pw-cnt{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:9px;font-family:'JetBrains Mono',monospace;pointer-events:none;padding:2px 5px;border-radius:4px}.pw-cnt.ok{color:var(--g);background:var(--g3)}.pw-cnt.no{color:var(--r);background:var(--r2)}
.numpad{display:grid;grid-template-columns:repeat(3,68px);gap:8px;opacity:.3;pointer-events:none}
.nk{width:68px;height:52px;border-radius:12px;border:1px solid var(--border);background:var(--bg2);color:var(--t1);font-size:22px;font-weight:600;display:flex;align-items:center;justify-content:center}
.lock-msg{font-size:12px;margin-top:8px;min-height:18px}.lock-msg.err{color:var(--r)}.lock-msg.ok{color:var(--g)}
.totp-screen{display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center}.totp-screen.show{display:flex}
.totp-input{width:200px;text-align:center;font-size:28px;font-weight:800;letter-spacing:12px;font-family:'JetBrains Mono',monospace;background:var(--bg2);border:2px solid var(--border);border-radius:14px;padding:14px;color:var(--t1);margin:14px 0}
.totp-timer{font-size:12px;color:var(--t3);margin-bottom:10px}.totp-timer span{color:var(--y);font-weight:700;font-family:'JetBrains Mono',monospace}
.totp-bar{width:200px;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;margin-bottom:16px}.totp-bar-fill{height:100%;background:var(--g);transition:width 1s linear;border-radius:2px}
.totp-err{color:var(--r);font-size:12px;min-height:18px;margin-bottom:6px}
#app{display:flex;flex-direction:column;height:100%;padding-top:var(--st)}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);background:rgba(11,14,20,0.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);flex-shrink:0;z-index:10}
.hdr-l{display:flex;align-items:center;gap:8px}.brand{font-size:16px;font-weight:800;color:var(--t1)}.brand span{color:var(--g)}
.cnt{background:var(--g3);color:var(--g);font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;font-family:'JetBrains Mono',monospace}
.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.sync-on{background:var(--g);box-shadow:0 0 6px var(--g)}.sync-off{background:var(--t4)}.sync-ing{background:var(--y);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.nav{display:flex;border-top:1px solid var(--border);background:rgba(11,14,20,0.95);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);flex-shrink:0;padding-bottom:var(--sb);z-index:10}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 0 6px;cursor:pointer;color:var(--t4);font-size:10px;font-weight:600;gap:2px;-webkit-user-select:none}.nav-item.act{color:var(--g)}.nav-item .ni{font-size:20px}
.vw{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}.anim{animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}.shake{animation:shake .3s}
.btn{border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:13px}.btn:active{opacity:.7}
.btn-g{background:var(--g);color:#fff;box-shadow:0 2px 10px rgba(46,204,113,0.2)}.btn-o{background:transparent;border:1px solid var(--border);color:var(--t3)}.btn-r{background:var(--r2);color:var(--r);border:1px solid var(--r3)}.btn-s{background:var(--g3);color:var(--g);border:1px solid var(--g4)}.btn-b{background:var(--b2);color:var(--b);border:1px solid rgba(52,152,219,0.2)}
.sbar{padding:10px 16px 6px}.sinp{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 14px;color:var(--t1);font-size:13px}
.flts{display:flex;gap:6px;padding:2px 16px 8px}.fsel{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:5px 8px;color:var(--t3);font-size:11px}
.clist{padding:2px 8px 20px}.empty{text-align:center;padding:50px 20px;color:var(--t3)}.empty .ei{font-size:40px;margin-bottom:10px}
.cc{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:12px;cursor:pointer;margin-bottom:2px;-webkit-user-select:none}.cc:active{background:var(--g3)}
.av{width:40px;height:40px;border-radius:50%;background:linear-gradient(140deg,var(--bg3),var(--bg5));display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:var(--g);flex-shrink:0;border:1px solid var(--border)}.av.lg{width:56px;height:56px;font-size:23px;background:linear-gradient(140deg,var(--g),var(--g2));color:#fff;border:none;box-shadow:0 4px 14px rgba(46,204,113,0.3)}
.ci{flex:1;min-width:0}.cn{font-size:13px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cs{font-size:11px;color:var(--t4);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cc-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.pb{background:var(--y2);color:var(--y);font-size:10px;font-weight:700;padding:1px 6px;border-radius:5px;font-family:'JetBrains Mono',monospace}
.debt-badge{font-size:10px;font-weight:700;padding:1px 6px;border-radius:5px;font-family:'JetBrains Mono',monospace}.debt-r{background:var(--r2);color:var(--r)}.debt-g{background:var(--g3);color:var(--g)}
.dhdr{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;position:sticky;top:0;background:rgba(11,14,20,0.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);z-index:5}.dacts{display:flex;gap:5px;align-items:center}
.pcard{background:linear-gradient(140deg,rgba(46,204,113,0.06),var(--bg2));border:1px solid var(--border);border-radius:16px;padding:18px;margin:4px 16px 14px;display:flex;align-items:center;gap:14px}.pname{font-size:19px;font-weight:800;color:var(--t1)}.prole{font-size:12px;color:var(--t3);margin-top:2px}
.trow{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}.tg{background:var(--g3);color:var(--g);font-size:10px;padding:2px 9px;border-radius:12px;font-weight:600}
.fgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;padding:0 16px 14px}
.fc{display:flex;align-items:flex-start;gap:8px;background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:11px 12px}.fi{font-size:15px;flex-shrink:0}.fl{font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.7px;font-weight:700;margin-bottom:1px}.fv{font-size:13px;color:var(--t1);font-weight:500;word-break:break-word}
.nbox{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:14px;margin:0 16px 12px}
.sec{padding:0 16px 14px}.sec-t{font-size:11px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.inv-card{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}.inv-left{flex:1;min-width:0}.inv-desc{font-size:12px;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.inv-date{font-size:10px;color:var(--t4);margin-top:2px}.inv-right{display:flex;align-items:center;gap:8px;flex-shrink:0}.inv-amt{font-size:15px;font-weight:800;font-family:'JetBrains Mono',monospace}
.inv-cur{font-size:10px;font-weight:700;padding:2px 6px;border-radius:5px;font-family:'JetBrains Mono',monospace}.cur-eur{background:var(--b2);color:var(--b)}.cur-usd{background:var(--g3);color:var(--g)}.cur-tnd{background:var(--o2);color:var(--o)}.cur-credit{background:var(--p2);color:var(--p)}
.inv-status{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;cursor:pointer;-webkit-user-select:none}.inv-paid{background:var(--g3);color:var(--g)}.inv-pending{background:var(--r2);color:var(--r)}.inv-del{font-size:13px;cursor:pointer;padding:4px;color:var(--t4)}
.inv-totals{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}.inv-total-chip{display:flex;align-items:center;gap:5px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:8px 12px}.inv-total-label{font-size:10px;color:var(--t4);font-weight:600}.inv-total-val{font-size:14px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--r)}.inv-total-val.zero{color:var(--g)}
.add-inv{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}.add-inv-title{font-size:11px;font-weight:700;color:var(--o);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.add-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}.add-row .fg{min-width:0}.add-row .fg.w1{flex:2}.add-row .fg.w2{flex:1}
.paid-toggle{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--border)}.pt-opt{padding:7px 12px;font-size:11px;font-weight:600;cursor:pointer;background:var(--bg2);color:var(--t3);-webkit-user-select:none;text-align:center}.pt-opt.act-g{background:var(--g3);color:var(--g)}.pt-opt.act-r{background:var(--r2);color:var(--r)}
.mth-card{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:12px 14px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}.mth-month{font-size:13px;font-weight:600;color:var(--t1)}.mth-amt{font-size:17px;font-weight:800;color:var(--y);font-family:'JetBrains Mono',monospace}
.mth-total{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}.mth-total-label{font-size:11px;color:var(--t3);font-weight:600}.mth-total-val{font-size:18px;font-weight:800;color:var(--g);font-family:'JetBrains Mono',monospace}.mth-avg{font-size:12px;color:var(--t3);font-weight:600}
.chart-box{margin:0 16px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px;overflow:hidden}.chart-box canvas{width:100%;height:140px}
.fhdr{display:flex;align-items:center;gap:12px;padding:10px 16px;position:sticky;top:0;background:rgba(11,14,20,0.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);z-index:5}.ftitle{font-size:16px;font-weight:700;color:var(--t1)}.fbody{padding:4px 16px 30px}.fsec{margin-bottom:18px}
.fstitle{font-size:10px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.fgr{display:grid;grid-template-columns:1fr 1fr;gap:10px}.fg{display:flex;flex-direction:column}.fg.full{grid-column:1/-1}.flab{font-size:11px;font-weight:600;color:var(--t3);margin-bottom:4px}
.finp{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--t1);font-size:13px}textarea.finp{resize:vertical;min-height:80px;line-height:1.5}
.facts{display:flex;gap:8px;margin-top:20px;padding-top:14px;border-top:1px solid var(--border)}.facts .btn{flex:1}.facts .btn-g{flex:2}
.add-mth{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}
.dash{padding:16px}.dash-cards{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}.dc{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}.dc-icon{font-size:20px;margin-bottom:4px}.dc-val{font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace}.dc-val.green{color:var(--g)}.dc-val.yellow{color:var(--y)}.dc-val.red{color:var(--r)}.dc-val.blue{color:var(--b)}.dc-lab{font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;font-weight:600}
.dash-chart{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px}.dash-chart h3{font-size:12px;font-weight:700;color:var(--t1);margin-bottom:10px}.dash-chart canvas{width:100%;height:200px}
.dash-section{margin-bottom:14px}.dash-section h3{font-size:11px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.top-item{display:flex;align-items:center;gap:8px;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:5px}.top-rank{font-size:13px;font-weight:800;color:var(--g);font-family:'JetBrains Mono',monospace;width:22px}.top-info{flex:1;min-width:0}.top-name{font-size:12px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.top-sub{font-size:10px;color:var(--t4)}
.sov{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:50;display:flex;align-items:flex-end;justify-content:center}.sov.hide{display:none}
.span{background:var(--bg);border:1px solid var(--border);border-radius:22px 22px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:20px 20px calc(20px + var(--sb))}.shandle{width:36px;height:4px;border-radius:2px;background:var(--bg4);margin:0 auto 16px}
.si{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
.tog{width:44px;height:26px;border-radius:13px;background:var(--bg4);cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}.tog.on{background:var(--g)}.togk{width:22px;height:22px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:transform .2s}.tog.on .togk{transform:translateX(18px)}
.imp-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:60;display:flex;align-items:center;justify-content:center;padding:20px}.imp-modal.hide{display:none}.imp-box{background:var(--bg);border:1px solid var(--border);border-radius:18px;padding:20px;width:100%;max-width:400px;max-height:80vh;overflow-y:auto}
.imp-list{max-height:280px;overflow-y:auto;margin:10px 0}.imp-item{display:flex;align-items:center;gap:10px;padding:9px;border-radius:10px;border:1px solid var(--border);margin-bottom:5px;cursor:pointer;-webkit-user-select:none}.imp-item.sel{border-color:var(--g);background:var(--g3)}.imp-check{width:18px;height:18px;border-radius:5px;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:11px;color:transparent}.imp-item.sel .imp-check{border-color:var(--g);background:var(--g);color:#fff}
.sec-box{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:10px}.sec-box-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.sync-box{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:10px}.sync-title{font-size:11px;font-weight:700;color:var(--b);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}.sync-status{display:flex;align-items:center;gap:8px;padding:8px 0;font-size:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:70;display:flex;align-items:center;justify-content:center;padding:20px}.modal.hide{display:none}.modal-box{background:var(--bg);border:1px solid var(--border);border-radius:18px;padding:24px;width:100%;max-width:380px;max-height:85vh;overflow-y:auto}
.modal-inp{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px;color:var(--t1);font-size:14px;font-family:'JetBrains Mono',monospace;margin-bottom:10px;-webkit-text-security:disc}
.modal-err{color:var(--r);font-size:11px;min-height:16px;margin-bottom:8px}
.tfa-qr{background:#fff;border-radius:12px;padding:10px;display:inline-block;margin:12px 0}.tfa-qr img{display:block;width:180px;height:180px}
.tfa-secret{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--y);background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px;margin:10px 0;letter-spacing:2px;word-break:break-all;-webkit-user-select:all}
.shield{display:inline-flex;align-items:center;gap:4px;background:var(--g3);color:var(--g);font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px}
.toast{position:fixed;bottom:calc(70px + var(--sb));left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--g4);color:var(--t1);padding:10px 20px;border-radius:12px;font-size:13px;font-weight:500;z-index:300;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}.toast.show{opacity:1}
</style>
</head>
<body>
<div class="lock" id="lock">
  <div id="pinScreen"><div style="font-size:52px;margin-bottom:18px">üîê</div><h2 id="lT">Entrer le code PIN</h2><p id="lS">Acc√®s prot√©g√©</p><div class="pw-wrap" id="pwWrap"><input class="pw-inp" id="pwInp" type="password" autocomplete="off" placeholder="Mot de passe"><div class="pw-cnt no" id="pwCnt">0</div></div><div class="numpad" id="numpad"></div><div class="lock-msg" id="lM"></div><button class="btn btn-g" id="lBtn" style="margin-top:14px;padding:10px 30px">D√©verrouiller</button></div>
  <div class="totp-screen" id="totpScreen"><div style="font-size:52px;margin-bottom:14px">üîë</div><h2 style="color:var(--t1);margin-bottom:2px">2FA</h2><p style="color:var(--t3);font-size:12px;margin-bottom:6px">Code Google Authenticator</p><div class="totp-bar"><div class="totp-bar-fill" id="totpBar"></div></div><div class="totp-timer">Expire dans <span id="totpTime">30</span>s</div><input class="totp-input" id="totpInp" type="tel" maxlength="6" placeholder="000000" inputmode="numeric"><div class="totp-err" id="totpErr"></div><button class="btn btn-g" id="totpBtn" style="padding:10px 30px">V√©rifier</button></div>
</div>
<div id="app"></div>
<div class="toast" id="toast"></div>
<script>
(function(){
/* ============ AES-256-GCM CRYPTO ============ */
const ENC=new TextEncoder(),DEC=new TextDecoder();
async function deriveKey(pw,salt,usage){
  const base=await crypto.subtle.importKey('raw',ENC.encode(pw),'PBKDF2',false,['deriveBits','deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},base,{name:'AES-GCM',length:256},false,usage);
}
async function hashPW(pw,salt){
  const key=await crypto.subtle.importKey('raw',ENC.encode(pw),'PBKDF2',false,['deriveBits']);
  const bits=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},key,256);
  return btoa(String.fromCharCode(...new Uint8Array(bits)));
}
async function encrypt(pw,data){
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(pw,salt,['encrypt']);
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,ENC.encode(JSON.stringify(data)));
  const buf=new Uint8Array(salt.length+iv.length+ct.byteLength);
  buf.set(salt,0);buf.set(iv,16);buf.set(new Uint8Array(ct),28);
  return btoa(String.fromCharCode(...buf));
}
async function decrypt(pw,b64){
  const raw=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
  const salt=raw.slice(0,16),iv=raw.slice(16,28),ct=raw.slice(28);
  const key=await deriveKey(pw,salt,['decrypt']);
  const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,ct);
  return JSON.parse(DEC.decode(pt));
}

/* ============ STORAGE ============ */
const SK='crm_vault',HK='crm_hash',SALT_K='crm_salt',SYK='crm_sync',TK='crm_totp_enc';
const OLD_LS=['crm_master','crm9','crm8','crm7','crm_v5'];
const OLD_PK=['crm_pw','crm_pin'];
let masterPW=null; // Only in memory, never stored

function getHash(){return localStorage.getItem(HK)}
function getSalt(){let s=localStorage.getItem(SALT_K);if(!s){const a=crypto.getRandomValues(new Uint8Array(16));s=btoa(String.fromCharCode(...a));localStorage.setItem(SALT_K,s)}return Uint8Array.from(atob(s),c=>c.charCodeAt(0))}
function hasVault(){return!!localStorage.getItem(SK)||!!getHash()}
function isNewUser(){return!hasVault()&&!getOldData()}

// Check for old unencrypted data
function getOldData(){for(const k of OLD_LS){try{const l=localStorage.getItem(k);if(l){const p=JSON.parse(l);if(Array.isArray(p)&&p.length)return p}}catch(e){}}return null}
function getOldPW(){for(const k of OLD_PK){const v=localStorage.getItem(k);if(v)return v}return null}

async function saveVault(data){
  if(!masterPW)return;
  const enc=await encrypt(masterPW,data);
  localStorage.setItem(SK,enc);
  cloudPush(enc);
}
async function loadVault(){
  if(!masterPW)return[];
  const enc=localStorage.getItem(SK);
  if(!enc)return[];
  try{return await decrypt(masterPW,enc)}catch(e){return[]}
}
async function setupVault(pw,data){
  masterPW=pw;
  const salt=getSalt();
  const h=await hashPW(pw,salt);
  localStorage.setItem(HK,h);
  await saveVault(data);
}
async function verifyPW(pw){
  const salt=getSalt();
  const h=await hashPW(pw,salt);
  return h===getHash();
}

// Encrypted TOTP
async function saveTOTP(secret){if(!masterPW||!secret){localStorage.removeItem(TK);return}const e=await encrypt(masterPW,{s:secret});localStorage.setItem(TK,e)}
async function loadTOTP(){if(!masterPW)return null;const e=localStorage.getItem(TK);if(!e)return null;try{const d=await decrypt(masterPW,e);return d.s||null}catch(e){return null}}
function hasTOTP(){return!!localStorage.getItem(TK)}

/* ============ TOTP ============ */
const B32='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
function b32enc(buf){let b='',r='';for(let i=0;i<buf.length;i++)b+=buf[i].toString(2).padStart(8,'0');for(let i=0;i<b.length;i+=5)r+=B32[parseInt(b.substr(i,5).padEnd(5,'0'),2)];return r}
function b32dec(s){let b='',bytes=[];s=s.replace(/=+$/,'').toUpperCase();for(let i=0;i<s.length;i++){const v=B32.indexOf(s[i]);if(v>=0)b+=v.toString(2).padStart(5,'0')}for(let i=0;i+8<=b.length;i+=8)bytes.push(parseInt(b.substr(i,8),2));return new Uint8Array(bytes)}
function genSecret(){return b32enc(crypto.getRandomValues(new Uint8Array(20)))}
async function calcTOTP(secret,time){const key=b32dec(secret);const t=Math.floor((time||Date.now()/1000)/30);const tb=new ArrayBuffer(8);new DataView(tb).setUint32(4,t);try{const ck=await crypto.subtle.importKey('raw',key,{name:'HMAC',hash:'SHA-1'},false,['sign']);const sig=await crypto.subtle.sign('HMAC',ck,tb);const h=new Uint8Array(sig);const o=h[h.length-1]&0xf;return(((h[o]&0x7f)<<24|(h[o+1]&0xff)<<16|(h[o+2]&0xff)<<8|(h[o+3]&0xff))%1000000).toString().padStart(6,'0')}catch(e){return null}}
async function verifyTOTP(secret,code){const now=Date.now()/1000;for(let i=-1;i<=1;i++){if(await calcTOTP(secret,now+i*30)===code)return true}return false}
function getQRURL(s){return`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent('otpauth://totp/MyCRM?secret='+s+'&issuer=MyCRM&digits=6&period=30')}`}

/* ============ CLOUD SYNC (encrypted) ============ */
function getSyncConf(){try{return JSON.parse(localStorage.getItem(SYK))||{}}catch(e){return{}}}
function setSyncConf(c){localStorage.setItem(SYK,JSON.stringify(c))}
let syncState='off';
async function cloudPush(encData){const conf=getSyncConf();if(!conf.url||!conf.code)return;syncState='syncing';try{ra()}catch(e){}try{const r=await fetch(conf.url.replace(/\/$/,'')+'/crm/'+encodeURIComponent(conf.code)+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({vault:encData||localStorage.getItem(SK),updated:Date.now()})});syncState=r.ok?'synced':'error'}catch(e){syncState='error'}try{ra()}catch(e){}}
async function cloudPull(){const conf=getSyncConf();if(!conf.url||!conf.code)return null;syncState='syncing';try{const r=await fetch(conf.url.replace(/\/$/,'')+'/crm/'+encodeURIComponent(conf.code)+'.json');if(!r.ok){syncState='error';return null}const d=await r.json();syncState='synced';return d?.vault||null}catch(e){syncState='error';return null}}
async function fullSync(){if(!masterPW)return;const remote=await cloudPull();if(!remote){await cloudPush();return}
  try{const remoteData=await decrypt(masterPW,remote);const localData=C;const map=new Map();remoteData.forEach(c=>map.set(c.id,c));localData.forEach(c=>{const ex=map.get(c.id);if(!ex||((c.lastModified||'')>=(ex.lastModified||'')))map.set(c.id,c)});C=[...map.values()];await saveVault(C);tt('‚òÅÔ∏è Sync OK ‚Äî '+C.length);ra()}catch(e){await cloudPush();tt('‚òÅÔ∏è Pushed');ra()}}

/* ============ APP STATE ============ */
const SECS=[{s:'Identit√©',f:[{k:'prenom',l:'Pr√©nom',i:'‚úèÔ∏è',t:'text'},{k:'nom',l:'Nom',i:'üë§',t:'text'},{k:'telephone',l:'T√©l√©phone',i:'üì±',t:'tel'},{k:'email',l:'Email',i:'‚úâÔ∏è',t:'email'},{k:'username',l:'Username',i:'üîë',t:'text'},{k:'dateNaissance',l:'Date naissance',i:'üéÇ',t:'date'}]},{s:'Professionnel',f:[{k:'entreprise',l:'Entreprise',i:'üè¢',t:'text'},{k:'poste',l:'Poste',i:'üíº',t:'text'},{k:'villeTravail',l:'Ville',i:'üèôÔ∏è',t:'text'},{k:'salaire',l:'Salaire',i:'üí∞',t:'number',sx:'‚Ç¨'},{k:'pourcentage',l:'% Commission',i:'üìä',t:'number',sx:'%'}]},{s:'Autres',f:[{k:'adresse',l:'Adresse',i:'üìç',t:'text',fu:1},{k:'tags',l:'Tags',i:'üè∑Ô∏è',t:'text',fu:1,ph:'VIP, prospect'},{k:'dernierContact',l:'Dernier contact',i:'üìÖ',t:'date'},{k:'notes',l:'Notes',i:'üìù',t:'textarea',fu:1}]}];
const AK=SECS.flatMap(s=>s.f.map(f=>f.k));
const MO=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];
const CURS=['EUR','USD','TND','Cr√©dit'];const CUR_CLS={EUR:'cur-eur',USD:'cur-usd',TND:'cur-tnd','Cr√©dit':'cur-credit'};const CUR_SYM={EUR:'‚Ç¨',USD:'$',TND:'TND','Cr√©dit':'CR'};const CUR_CLR={EUR:'var(--b)',USD:'var(--g)',TND:'var(--o)','Cr√©dit':'var(--p)'};

let C=[],tab='list',vw='list',sid=null,ed=null,sq='',so='nom',ft='',dc=null,stg=false,impModal=false,impData=[],impSel=new Set(),tfaModal=false,tfaSetupSecret='',chpwModal=false,chpwStep=0,newPW='';
let pm='unlock',pe='',pl=true; // Always start locked
let mM='',mA='',iDesc='',iAmt='',iCur='EUR',iPaid=false,totpTimer=null,totpSecret=null;

async function init(){
  if(isNewUser()){pm='setup';pe=''}
  else{pm='unlock';pe=''}
  rl();
}

/* ============ LOCK ============ */
function rl(){
  const el=document.getElementById('lock'),pinS=document.getElementById('pinScreen'),totpS=document.getElementById('totpScreen');
  if(!pl){el.classList.add('out');stopTotpTimer();return}el.classList.remove('out');
  if(pm==='totp'){pinS.style.display='none';totpS.classList.add('show');startTotpTimer();setTimeout(()=>document.getElementById('totpInp')?.focus(),100);return}
  pinS.style.display='';totpS.classList.remove('show');stopTotpTimer();
  const isS=pm==='setup',isC=pm==='confirm';
  document.getElementById('lT').textContent=isS?'Cr√©er un mot de passe':isC?'Confirmer':'Entrer le code PIN';
  document.getElementById('lS').textContent=isS?'Min. 8 caract√®res (lettres + chiffres)':isC?'Retapez le mot de passe':'Acc√®s prot√©g√©';
  const msg=document.getElementById('lM');msg.textContent=pe;msg.className='lock-msg'+(pe?' err':'');
  document.getElementById('lBtn').textContent=isS?'Suivant':isC?'Confirmer':'D√©verrouiller';
  const pad=document.getElementById('numpad');pad.innerHTML='';
  [1,2,3,4,5,6,7,8,9,'*',0,'#'].forEach(n=>{const b=document.createElement('div');b.className='nk';b.textContent=n;pad.appendChild(b)});
  const inp=document.getElementById('pwInp');inp.value='';inp.placeholder=isS||isC?'Nouveau mot de passe':'Entrer le code';inp.focus();updatePwCnt();
}
function updatePwCnt(){const inp=document.getElementById('pwInp'),cnt=document.getElementById('pwCnt');if(!inp||!cnt)return;const l=inp.value.length;cnt.textContent=l;cnt.className='pw-cnt '+(l>=8?'ok':'no')}

let setupPW='';
async function pwSubmit(){
  const inp=document.getElementById('pwInp'),val=inp?.value||'';
  if(pm==='unlock'){
    const ok=await verifyPW(val);
    if(ok){masterPW=val;C=await loadVault();
      // Migrate old unencrypted data if vault empty
      if(!C.length){const old=getOldData();if(old&&old.length){C=old;await saveVault(C);OLD_LS.forEach(k=>localStorage.removeItem(k));OLD_PK.forEach(k=>localStorage.removeItem(k))}}
      totpSecret=await loadTOTP();
      if(totpSecret){pm='totp';rl();return}
      pe='';pl=false;rl();ra();
      const conf=getSyncConf();if(conf.url&&conf.code)fullSync();
    }else{pe='Mot de passe incorrect';rl();document.getElementById('pwWrap')?.classList.add('shake')}
  }else if(pm==='setup'){
    if(val.length<8){pe='Minimum 8 caract√®res';rl();return}setupPW=val;pm='confirm';pe='';rl();
  }else if(pm==='confirm'){
    if(val===setupPW){
      const old=getOldData()||[];
      await setupVault(val,old);C=old;
      OLD_LS.forEach(k=>localStorage.removeItem(k));OLD_PK.forEach(k=>localStorage.removeItem(k));
      pe='';pl=false;setupPW='';rl();ra();tt('üîê Coffre-fort cr√©√©');
    }else{pe='Ne correspond pas';pm='setup';setupPW='';rl();document.getElementById('pwWrap')?.classList.add('shake')}
  }
}

function startTotpTimer(){stopTotpTimer();updateTotpTimer();totpTimer=setInterval(updateTotpTimer,1000)}
function stopTotpTimer(){if(totpTimer){clearInterval(totpTimer);totpTimer=null}}
function updateTotpTimer(){const s=30-Math.floor(Date.now()/1000)%30;const el=document.getElementById('totpTime');if(el)el.textContent=s;const bar=document.getElementById('totpBar');if(bar)bar.style.width=(s/30*100)+'%'}
async function doTotpVerify(){const inp=document.getElementById('totpInp'),err=document.getElementById('totpErr');const code=inp?.value?.trim();if(!code||code.length!==6){if(err)err.textContent='6 chiffres';return}if(await verifyTOTP(totpSecret,code)){pe='';pl=false;rl();ra();tt('‚úÖ Authentifi√©');const conf=getSyncConf();if(conf.url&&conf.code)fullSync()}else{if(err)err.textContent='‚ùå Code invalide';if(inp){inp.value='';inp.focus()}}}
function tt(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200)}
function Q(s,fn){const e=document.querySelector(s);if(e)fn(e)}
function E(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function mkN(){const c={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),dateAjout:new Date().toISOString().split('T')[0],lastModified:new Date().toISOString(),fav:false,monthly:[],invoices:[]};AK.forEach(k=>{if(!c[k])c[k]=''});return c}
function fmt(n){return Math.round(n).toLocaleString('fr')}
function fmtM(d){if(!d)return'?';const p=d.split('-');if(p.length>=2)return MO[parseInt(p[1])-1]+' '+p[0].slice(2);return d}
function pendByCur(c){const r={};(c.invoices||[]).filter(i=>!i.paid).forEach(i=>{const cur=i.currency||'EUR';r[cur]=(r[cur]||0)+Number(i.amount||0)});return r}
function totalPending(c){return(c.invoices||[]).filter(i=>!i.paid).reduce((s,i)=>s+Number(i.amount||0),0)}
function totalCA(c){return(c.monthly||[]).reduce((s,m)=>s+Number(m.amount||0),0)}

async function sv(){await saveVault(C)}

function ra(){
  const a=document.getElementById('app');let h='';const conf=getSyncConf(),hasSy=conf.url&&conf.code;
  const syncDot=hasSy?`<div class="sync-dot ${syncState==='synced'?'sync-on':syncState==='syncing'?'sync-ing':'sync-off'}"></div>`:'';
  h+=`<div class="hdr"><div class="hdr-l"><span style="font-size:16px">üîí</span><span class="brand">My<span>CRM</span></span><div class="shield">üõ°Ô∏è AES-256</div><span class="cnt">${C.length}</span>${syncDot}</div><div style="display:flex;gap:6px">${tab==='list'&&vw==='list'?`<button class="btn btn-s" id="sB" style="padding:5px 9px;font-size:13px">‚öôÔ∏è</button><button class="btn btn-g" id="aB" style="padding:7px 12px">+ Nouveau</button>`:''}</div></div>`;
  h+=rSettings()+rImpModal()+rTfaModal()+rChpwModal();
  if(tab==='list'&&vw==='list')h+=rList();else if(tab==='list'&&vw==='detail')h+=rDetail();else if(tab==='list'&&vw==='form')h+=rForm();else if(tab==='dash')h+=rDash();
  h+=`<div class="nav"><div class="nav-item ${tab==='list'?'act':''}" data-tab="list"><div class="ni">üë•</div>Contacts</div><div class="nav-item ${tab==='dash'?'act':''}" data-tab="dash"><div class="ni">üìä</div>Dashboard</div></div>`;
  a.innerHTML=h;bindAll();
  if(tab==='dash')drawDashChart();if(vw==='detail'&&sid)drawMini();
}

function gf(){const q=sq.toLowerCase();return C.filter(c=>{const m=!q||Object.values(c).some(v=>typeof v==='string'&&v.toLowerCase().includes(q));const t=!ft||(c.tags&&c.tags.toLowerCase().includes(ft.toLowerCase()));return m&&t}).sort((a,b)=>{if(so==='fav')return(b.fav?1:0)-(a.fav?1:0);if(so==='debt')return totalPending(b)-totalPending(a);if(so==='ca')return totalCA(b)-totalCA(a);return(a[so]||'').toLowerCase().localeCompare((b[so]||'').toLowerCase())})}
function aTags(){return[...new Set(C.flatMap(c=>c.tags?c.tags.split(',').map(t=>t.trim()).filter(Boolean):[]))]}

function rList(){const f=gf(),tg=aTags();let items='';
  if(!f.length){items=C.length?'<div class="empty"><div class="ei">üîç</div>Aucun r√©sultat</div>':'<div class="empty"><div class="ei">üìã</div><div>Aucun contact</div></div>'}
  else{items=f.map(c=>{const pend=pendByCur(c),pK=Object.keys(pend),badges=pK.map(cur=>`<div class="debt-badge debt-r">${fmt(pend[cur])} ${CUR_SYM[cur]}</div>`).join(''),ca=totalCA(c);
    return`<div class="cc anim" data-id="${c.id}"><div class="av">${(c.prenom?.[0]||c.nom?.[0]||'?').toUpperCase()}</div><div class="ci"><div class="cn">${c.fav?'‚≠ê ':''}${E(c.prenom)} ${E(c.nom)}</div><div class="cs">${E([c.entreprise,c.villeTravail].filter(Boolean).join(' ¬∑ '))||'‚Äî'}</div></div><div class="cc-right">${ca?`<div class="pb">${fmt(ca)} ‚Ç¨</div>`:''}${c.pourcentage?`<div class="pb" style="background:var(--b2);color:var(--b)">${E(c.pourcentage)}%</div>`:''}${badges}${!pK.length&&(c.invoices||[]).length?'<div class="debt-badge debt-g">‚úÖ</div>':''}</div></div>`}).join('')}
  const to=tg.map(t=>`<option value="${E(t)}" ${ft===t?'selected':''}>${E(t)}</option>`).join('');
  return`<div class="vw anim"><div class="sbar"><input class="sinp" id="si" placeholder="üîç  Rechercher..." value="${E(sq)}"></div><div class="flts"><select class="fsel" id="ss"><option value="nom" ${so==='nom'?'selected':''}>Nom</option><option value="fav" ${so==='fav'?'selected':''}>‚≠ê Favoris</option><option value="ca" ${so==='ca'?'selected':''}>üìà CA</option><option value="debt" ${so==='debt'?'selected':''}>üí∏ Dettes</option><option value="entreprise" ${so==='entreprise'?'selected':''}>Entreprise</option></select>${tg.length?`<select class="fsel" id="ts"><option value="">Tous</option>${to}</select>`:''}</div><div class="clist">${items}</div></div>`}

function rDetail(){const c=C.find(x=>x.id===sid);if(!c)return'';const tgs=c.tags?c.tags.split(',').map(t=>t.trim()).filter(Boolean):[];
  const fields=SECS.flatMap(s=>s.f).filter(f=>f.k!=='notes'&&f.k!=='tags'&&c[f.k]).map(f=>{let v=E(c[f.k]);if(f.sx)v+=f.sx;return`<div class="fc"><div class="fi">${f.i}</div><div><div class="fl">${f.l}</div><div class="fv">${v}</div></div></div>`}).join('');
  const invs=c.invoices||[],pend=pendByCur(c),pK=Object.keys(pend);
  const totH=pK.length?pK.map(cur=>`<div class="inv-total-chip"><div class="inv-total-label">D√ª ${cur}</div><div class="inv-total-val">${fmt(pend[cur])} ${CUR_SYM[cur]}</div></div>`).join(''):'<div class="inv-total-chip"><div class="inv-total-val zero">‚úÖ Aucune dette</div></div>';
  const invH=invs.map((inv,i)=>`<div class="inv-card"><div class="inv-left"><div class="inv-desc">${E(inv.desc||'Facture')}</div><div class="inv-date">${E(inv.date||'')}</div></div><div class="inv-right"><div class="inv-amt" style="color:${inv.paid?'var(--g)':'var(--r)'}">${fmt(inv.amount)}</div><div class="inv-cur ${CUR_CLS[inv.currency]||'cur-eur'}">${inv.currency||'EUR'}</div><div class="inv-status ${inv.paid?'inv-paid':'inv-pending'}" data-ti="${i}">${inv.paid?'‚úÖ Pay√©':'‚è≥ D√ª'}</div><div class="inv-del" data-di="${i}">üóëÔ∏è</div></div></div>`).join('');
  const monthly=(c.monthly||[]).sort((a,b)=>a.date>b.date?-1:1),totalCa=monthly.reduce((s,m)=>s+Number(m.amount||0),0),avgCa=monthly.length?totalCa/monthly.length:0;
  const mthH=monthly.map((m,i)=>`<div class="mth-card"><div class="mth-month">${fmtM(m.date)}</div><div style="display:flex;align-items:center;gap:8px"><div class="mth-amt">${Number(m.amount).toLocaleString('fr')} ‚Ç¨</div><div class="inv-del" data-mi="${i}">üóëÔ∏è</div></div></div>`).join('');
  const delH=dc===c.id?`<div style="display:flex;gap:4px"><button class="btn btn-r" id="cY" style="padding:4px 10px;font-size:11px">Oui</button><button class="btn btn-o" id="cN" style="padding:4px 10px;font-size:11px">Non</button></div>`:`<button class="btn btn-r" id="dB" style="padding:5px 8px;font-size:12px">üóëÔ∏è</button>`;
  return`<div class="vw anim"><div class="dhdr"><button class="btn btn-o" id="bB" style="padding:5px 11px;font-size:12px">‚Üê Retour</button><div class="dacts"><button style="font-size:18px;background:none;border:none;cursor:pointer;padding:4px" id="togFav">${c.fav?'‚≠ê':'‚òÜ'}</button><button class="btn btn-s" id="eB" style="padding:5px 11px;font-size:12px">‚úèÔ∏è</button>${delH}</div></div>
    <div class="pcard"><div class="av lg">${(c.prenom?.[0]||c.nom?.[0]||'?').toUpperCase()}</div><div><div class="pname">${c.fav?'‚≠ê ':''}${E(c.prenom)} ${E(c.nom)}</div><div class="prole">${E([c.poste,c.entreprise].filter(Boolean).join(' ‚Äî '))||'‚Äî'}</div>${tgs.length?`<div class="trow">${tgs.map(t=>`<span class="tg">${E(t)}</span>`).join('')}</div>`:''}</div></div>
    <div class="fgrid">${fields}</div>
    ${c.notes?`<div class="nbox"><div style="font-size:12px;font-weight:700;color:var(--t1);margin-bottom:5px">üìù Notes</div><div style="font-size:12px;color:var(--t3);white-space:pre-wrap;line-height:1.6">${E(c.notes)}</div></div>`:''}
    <div class="sec"><div class="sec-t">üßæ Factures (${invs.length})</div><div class="inv-totals">${totH}</div>${invH}
      <div class="add-inv"><div class="add-inv-title">+ Facture</div><div class="add-row"><div class="fg w1"><label class="flab">Desc</label><input class="finp" id="iD" value="${E(iDesc)}" placeholder="Commission"></div><div class="fg w2"><label class="flab">Montant</label><input class="finp" type="number" id="iA" value="${iAmt}" placeholder="0"></div></div><div class="add-row"><div class="fg w2"><label class="flab">Devise</label><select class="finp" id="iC">${CURS.map(c=>`<option value="${c}" ${iCur===c?'selected':''}>${c}</option>`).join('')}</select></div><div class="fg w2"><label class="flab">Statut</label><div class="paid-toggle"><div class="pt-opt ${!iPaid?'act-r':''}" id="iPR">‚è≥ D√ª</div><div class="pt-opt ${iPaid?'act-g':''}" id="iPG">‚úÖ Pay√©</div></div></div><div class="fg" style="justify-content:flex-end"><button class="btn btn-g" id="addI" style="padding:9px 16px">+</button></div></div></div></div>
    ${monthly.length?`<div class="chart-box"><div style="font-size:12px;font-weight:700;color:var(--t1);margin-bottom:8px">üìà CA</div><canvas id="miniC" height="140"></canvas></div>`:''}
    <div class="sec"><div class="sec-t">üìà CA (${monthly.length})</div>
      ${monthly.length?`<div class="mth-total"><div><div class="mth-total-label">CA Total</div><div class="mth-total-val">${fmt(totalCa)} ‚Ç¨</div></div><div class="mth-avg">Moy: ${fmt(avgCa)} ‚Ç¨/mois</div></div>`:''}${mthH}
      <div class="add-mth"><div style="font-size:11px;font-weight:700;color:var(--y);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">+ Mois</div><div style="display:flex;gap:8px;margin-bottom:10px"><div class="fg" style="flex:1"><label class="flab">Mois</label><input class="finp" type="month" id="mMi" value="${mM}"></div><div class="fg" style="flex:1"><label class="flab">CA ‚Ç¨</label><input class="finp" type="number" id="mAi" value="${mA}" placeholder="0"></div></div><div style="display:flex;justify-content:flex-end"><button class="btn btn-g" id="addM" style="padding:8px 20px">üìà +</button></div></div></div></div>`}

function rForm(){const c=ed,nw=!C.find(x=>x.id===c.id);const secs=SECS.map(s=>{const fs=s.f.map(f=>{const v=E(c[f.k]||''),fc=f.fu?'fg full':'fg';if(f.t==='textarea')return`<div class="${fc}"><label class="flab">${f.i} ${f.l}</label><textarea class="finp" data-f="${f.k}" placeholder="${f.ph||''}">${v}</textarea></div>`;return`<div class="${fc}"><label class="flab">${f.i} ${f.l}</label><input class="finp" type="${f.t}" data-f="${f.k}" value="${v}" placeholder="${f.ph||''}"></div>`}).join('');return`<div class="fsec"><div class="fstitle">${s.s}</div><div class="fgr">${fs}</div></div>`}).join('');
  return`<div class="vw anim"><div class="fhdr"><button class="btn btn-o" id="fBk" style="padding:5px 11px;font-size:12px">‚Üê Annuler</button><span class="ftitle">${nw?'Nouveau':'Modifier'}</span></div><div class="fbody">${secs}<div class="facts"><button class="btn btn-o" id="fCa">Annuler</button><button class="btn btn-g" id="fSv">üíæ Enregistrer</button></div></div></div>`}

function rDash(){const tc=C.length,fv=C.filter(c=>c.fav).length;const pBC={};C.flatMap(c=>c.invoices||[]).filter(i=>!i.paid).forEach(i=>{const c=i.currency||'EUR';pBC[c]=(pBC[c]||0)+Number(i.amount||0)});
  const aM=C.flatMap(c=>c.monthly||[]),tCA=aM.reduce((s,m)=>s+Number(m.amount||0),0);
  const pC=Object.keys(pBC).map(cur=>`<div class="dc"><div class="dc-icon">üßæ</div><div class="dc-val red">${fmt(pBC[cur])}</div><div class="dc-lab">D√ª ${cur}</div></div>`).join('');
  const bCA=C.map(c=>({c,ca:totalCA(c)})).filter(d=>d.ca>0).sort((a,b)=>b.ca-a.ca).slice(0,5);
  const caH=bCA.map((d,i)=>`<div class="top-item"><div class="top-rank">#${i+1}</div><div class="top-info"><div class="top-name">${E(d.c.prenom)} ${E(d.c.nom)}</div><div class="top-sub">${E(d.c.entreprise)||'‚Äî'}</div></div><div style="font-size:14px;font-weight:700;color:var(--y);font-family:'JetBrains Mono',monospace">${fmt(d.ca)} ‚Ç¨</div></div>`).join('');
  const drs=C.map(c=>({c,d:pendByCur(c)})).filter(d=>Object.keys(d.d).length).sort((a,b)=>totalPending(b.c)-totalPending(a.c)).slice(0,5);
  const dH=drs.map((d,i)=>`<div class="top-item"><div class="top-rank">#${i+1}</div><div class="top-info"><div class="top-name">${E(d.c.prenom)} ${E(d.c.nom)}</div></div><div>${Object.keys(d.d).map(cur=>`<span style="color:${CUR_CLR[cur]};font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace">${fmt(d.d[cur])}${CUR_SYM[cur]}</span>`).join('+')}</div></div>`).join('');
  const bM={};aM.forEach(m=>{bM[m.date||'?']=(bM[m.date||'?']||0)+Number(m.amount||0)});
  return`<div class="vw anim"><div class="dash"><div class="dash-cards"><div class="dc"><div class="dc-icon">üë•</div><div class="dc-val green">${tc}</div><div class="dc-lab">Contacts</div></div><div class="dc"><div class="dc-icon">‚≠ê</div><div class="dc-val yellow">${fv}</div><div class="dc-lab">Favoris</div></div><div class="dc"><div class="dc-icon">üìà</div><div class="dc-val yellow">${fmt(tCA)} ‚Ç¨</div><div class="dc-lab">CA Total</div></div><div class="dc"><div class="dc-icon">üìä</div><div class="dc-val blue">${aM.length?fmt(tCA/new Set(aM.map(m=>m.date)).size):0} ‚Ç¨</div><div class="dc-lab">CA Moy</div></div>${pC}</div>${Object.keys(bM).length?`<div class="dash-chart"><h3>üìà CA</h3><canvas id="dashC" height="200"></canvas></div>`:''}${bCA.length?`<div class="dash-section"><h3>üèÜ Top CA</h3>${caH}</div>`:''}${drs.length?`<div class="dash-section"><h3>üßæ D√©biteurs</h3>${dH}</div>`:''}</div></div>`}

function rSettings(){const conf=getSyncConf(),hasSy=conf.url&&conf.code,hasTfa=!!totpSecret;
  const sTxt=!hasSy?'Off':syncState==='synced'?'‚úÖ OK':syncState==='syncing'?'‚è≥...':'‚ùå';
  return`<div class="sov ${stg?'':'hide'}" id="sO"><div class="span"><div class="shandle"></div><div style="font-size:15px;font-weight:700;color:var(--t1);margin-bottom:14px">‚öôÔ∏è Param√®tres</div>
    <div class="sec-box"><div class="sec-box-title" style="color:var(--g)">üîê S√©curit√©</div>
      <div style="font-size:11px;color:var(--t3);margin-bottom:8px">Chiffrement AES-256-GCM ‚Ä¢ PBKDF2 200k it√©rations</div>
      <button class="btn btn-s" id="chP" style="width:100%;padding:10px;margin-bottom:6px">üîë Changer le mot de passe</button>
      <div style="font-size:12px;color:var(--t2);margin:10px 0 6px">${hasTfa?'<span style="color:var(--g);font-weight:700">üõ°Ô∏è 2FA activ√©</span>':'2FA non activ√©'}</div>
      ${hasTfa?`<button class="btn btn-r" id="tfa2Off" style="width:100%;padding:10px">D√©sactiver 2FA</button>`:`<button class="btn btn-g" id="tfa2On" style="width:100%;padding:10px">üîë Activer 2FA</button>`}
    </div>
    <div class="sync-box"><div class="sync-title">‚òÅÔ∏è Sync (chiffr√©)</div>
      <div class="sync-status"><div class="sync-dot ${hasSy?(syncState==='synced'?'sync-on':'sync-off'):'sync-off'}"></div><span style="font-size:12px;color:var(--t2)">${sTxt}</span></div>
      <div class="fg" style="margin-bottom:8px"><label class="flab">URL Firebase</label><input class="finp" id="syUrl" value="${E(conf.url||'')}" placeholder="https://xxx.firebaseio.com"></div>
      <div class="fg" style="margin-bottom:8px"><label class="flab">Code sync</label><input class="finp" id="syCode" value="${E(conf.code||'')}" placeholder="mon-code"></div>
      <div style="display:flex;gap:6px"><button class="btn btn-b" id="sySave" style="flex:1;padding:10px">üíæ</button>${hasSy?`<button class="btn btn-g" id="sySync" style="flex:1;padding:10px">üîÑ Sync</button>`:''}</div>
    </div>
    <button class="btn btn-s" id="impTg" style="width:100%;margin-top:10px;padding:10px">üì± Telegram</button>
    <button class="btn btn-s" id="expB" style="width:100%;margin-top:8px;padding:10px">üì§ Export</button>
    <label class="btn btn-s" style="width:100%;margin-top:8px;padding:10px;display:block;text-align:center;cursor:pointer">üì• Import<input type="file" accept=".json" id="impF" style="display:none"></label>
    <button class="btn btn-r" id="nukB" style="width:100%;margin-top:16px;padding:10px">üóëÔ∏è Tout supprimer</button>
  </div></div>`}

function rChpwModal(){if(!chpwModal)return'<div class="modal hide"></div>';
  return`<div class="modal" id="chpwMod"><div class="modal-box"><div style="font-size:36px;text-align:center;margin-bottom:10px">üîë</div><h3 style="font-size:15px;font-weight:700;color:var(--t1);text-align:center;margin-bottom:14px">${chpwStep===0?'Mot de passe actuel':chpwStep===1?'Nouveau (8+ car.)':'Confirmer'}</h3><input class="modal-inp" id="chpwInp" type="password" placeholder="${chpwStep===0?'Actuel':chpwStep===1?'Nouveau':'Confirmer'}" autocomplete="off"><div class="modal-err" id="chpwErr"></div><div style="display:flex;gap:8px"><button class="btn btn-o" id="chpwCancel" style="flex:1;padding:10px">Annuler</button><button class="btn btn-g" id="chpwOk" style="flex:1;padding:10px">${chpwStep===2?'‚úÖ Changer':'‚Üí'}</button></div></div></div>`}

function rTfaModal(){if(!tfaModal)return'<div class="modal hide" id="tfaModX"></div>';const s=tfaSetupSecret;
  return`<div class="modal" id="tfaMod"><div class="modal-box" style="text-align:center"><div style="font-size:40px;margin-bottom:10px">üîë</div><h3 style="font-size:16px;font-weight:700;color:var(--t1);margin-bottom:6px">Google Authenticator</h3><div class="tfa-qr"><img src="${getQRURL(s)}" alt="QR"></div><p style="font-size:11px;color:var(--t4);margin:6px 0">Cl√© manuelle :</p><div class="tfa-secret">${s.match(/.{1,4}/g).join(' ')}</div><p style="font-size:12px;color:var(--t1);font-weight:600;margin:10px 0 4px">V√©rifie :</p><input class="modal-inp" id="tfaVInp" type="tel" maxlength="6" placeholder="000000" inputmode="numeric" style="text-align:center;font-size:24px;letter-spacing:10px;-webkit-text-security:none"><div class="modal-err" id="tfaVErr"></div><div style="display:flex;gap:8px"><button class="btn btn-o" id="tfaCancel" style="flex:1;padding:10px">Annuler</button><button class="btn btn-g" id="tfaConfirm" style="flex:1;padding:10px">‚úÖ Activer</button></div></div></div>`}

function rImpModal(){if(!impModal)return'<div class="imp-modal hide"></div>';
  const items=impData.map((c,i)=>`<div class="imp-item ${impSel.has(i)?'sel':''}" data-ii="${i}"><div class="imp-check">${impSel.has(i)?'‚úì':''}</div><div><div style="font-size:13px;font-weight:600;color:var(--t1)">${E(c.first_name||'')} ${E(c.last_name||'')}</div><div style="font-size:11px;color:var(--t4)">${E(c.phone_number||c.username||'')}</div></div></div>`).join('');
  return`<div class="imp-modal" id="impMod"><div class="imp-box"><h3 style="font-size:16px;font-weight:700;color:var(--t1);margin-bottom:12px">üì± Telegram</h3><label class="btn btn-s" style="display:block;text-align:center;cursor:pointer;padding:10px">üìÇ Fichier<input type="file" accept=".json" id="tgF" style="display:none"></label>${impData.length?`<div style="margin:8px 0;font-size:11px;color:var(--t3)">${impData.length} trouv√©s <button class="btn btn-s" id="selA" style="padding:2px 8px;font-size:10px;margin-left:6px">Tout</button></div><div class="imp-list">${items}</div><button class="btn btn-g" id="doImp" style="width:100%;margin-top:8px;padding:10px">Importer ${impSel.size}</button>`:''}
    <button class="btn btn-o" id="clImp" style="width:100%;margin-top:8px;padding:10px">Fermer</button></div></div>`}

function drawDashChart(){const aM=C.flatMap(c=>c.monthly||[]);const bM={};aM.forEach(m=>{bM[m.date||'?']=(bM[m.date||'?']||0)+Number(m.amount||0)});const ks=Object.keys(bM).sort();if(!ks.length)return;const cv=document.getElementById('dashC');if(!cv)return;const ctx=cv.getContext('2d');const W=cv.parentElement.clientWidth-28;cv.width=W*2;cv.height=400;ctx.scale(2,2);const h=160,pad=35,mx=Math.max(...ks.map(k=>bM[k]),1),gap=(W-pad*2)/ks.length,bw=Math.min(30,gap*.65);for(let i=0;i<=4;i++){const y=pad+h-h*(i/4);ctx.strokeStyle='#1c2733';ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-5,y);ctx.stroke();ctx.fillStyle='#4e5d6e';ctx.font='8px JetBrains Mono';ctx.textAlign='right';ctx.fillText(fmt(mx*i/4),pad-4,y+3)}ks.forEach((k,i)=>{const x=pad+gap*i+gap/2,bh=bM[k]/mx*h;const gr=ctx.createLinearGradient(0,pad+h-bh,0,pad+h);gr.addColorStop(0,'#f1c40f');gr.addColorStop(1,'#e67e22');ctx.fillStyle=gr;ctx.beginPath();ctx.roundRect(x-bw/2,pad+h-bh,bw,bh,4);ctx.fill();ctx.fillStyle='#7e8d9e';ctx.font='8px Inter';ctx.textAlign='center';ctx.fillText(fmtM(k),x,pad+h+12);ctx.fillStyle='#f0f2f5';ctx.font='bold 9px JetBrains Mono';ctx.fillText(fmt(bM[k]),x,pad+h-bh-5)})}
function drawMini(){const c=C.find(x=>x.id===sid);if(!c)return;const mo=(c.monthly||[]).sort((a,b)=>a.date>b.date?1:-1);if(!mo.length)return;const cv=document.getElementById('miniC');if(!cv)return;const ctx=cv.getContext('2d');const W=cv.parentElement.clientWidth-28;cv.width=W*2;cv.height=280;ctx.scale(2,2);const h=100,pad=30,mx=Math.max(...mo.map(m=>Number(m.amount||0)),1),gap=(W-pad*2)/Math.max(mo.length-1,1);for(let i=0;i<=3;i++){const y=pad+h-h*(i/3);ctx.strokeStyle='#1c2733';ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-5,y);ctx.stroke();ctx.fillStyle='#4e5d6e';ctx.font='8px JetBrains Mono';ctx.textAlign='right';ctx.fillText(fmt(mx*i/3),pad-4,y+3)}ctx.beginPath();ctx.moveTo(pad,pad+h);mo.forEach((m,i)=>{ctx.lineTo(pad+gap*i,pad+h-Number(m.amount||0)/mx*h)});ctx.lineTo(pad+gap*(mo.length-1),pad+h);ctx.closePath();const gr=ctx.createLinearGradient(0,pad,0,pad+h);gr.addColorStop(0,'rgba(241,196,15,0.2)');gr.addColorStop(1,'rgba(241,196,15,0)');ctx.fillStyle=gr;ctx.fill();ctx.beginPath();mo.forEach((m,i)=>{const x=pad+gap*i,y=pad+h-Number(m.amount||0)/mx*h;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});ctx.strokeStyle='#f1c40f';ctx.lineWidth=2.5;ctx.stroke();mo.forEach((m,i)=>{const x=pad+gap*i,y=pad+h-Number(m.amount||0)/mx*h;ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fillStyle='#f1c40f';ctx.fill();ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();ctx.fillStyle='#7e8d9e';ctx.font='8px Inter';ctx.textAlign='center';ctx.fillText(fmtM(m.date),x,pad+h+12);ctx.fillStyle='#f0f2f5';ctx.font='bold 8px JetBrains Mono';ctx.fillText(fmt(m.amount),x,y-8)})}

function bindAll(){
  const pwI=document.getElementById('pwInp');if(pwI){pwI.oninput=updatePwCnt;pwI.onkeydown=e=>{if(e.key==='Enter')pwSubmit()}}
  Q('#lBtn',e=>e.onclick=pwSubmit);
  const tI=document.getElementById('totpInp');if(tI){tI.value='';tI.oninput=()=>{tI.value=tI.value.replace(/\D/g,'').slice(0,6);if(tI.value.length===6)doTotpVerify()}}
  Q('#totpBtn',e=>e.onclick=doTotpVerify);
  document.querySelectorAll('.nav-item').forEach(n=>n.onclick=()=>{tab=n.dataset.tab;vw=tab==='dash'?'dash':'list';sid=null;ra()});
  Q('#sB',e=>e.onclick=()=>{stg=true;ra()});Q('#aB',e=>e.onclick=()=>{ed=mkN();vw='form';ra()});
  Q('#sO',e=>e.onclick=v=>{if(v.target===e){stg=false;ra()}});
  Q('#chP',e=>e.onclick=()=>{chpwModal=true;chpwStep=0;stg=false;ra();setTimeout(()=>document.getElementById('chpwInp')?.focus(),100)});
  Q('#chpwCancel',e=>e.onclick=()=>{chpwModal=false;ra()});Q('#chpwMod',e=>e.onclick=v=>{if(v.target===e){chpwModal=false;ra()}});
  Q('#chpwInp',e=>{e.onkeydown=ev=>{if(ev.key==='Enter')doChpw()}});Q('#chpwOk',e=>e.onclick=doChpw);
  Q('#tfa2On',e=>e.onclick=()=>{tfaSetupSecret=genSecret();tfaModal=true;stg=false;ra();setTimeout(()=>document.getElementById('tfaVInp')?.focus(),200)});
  Q('#tfa2Off',e=>e.onclick=async()=>{if(confirm('D√©sactiver 2FA ?')){totpSecret=null;await saveTOTP(null);tt('2FA off');ra()}});
  Q('#tfaCancel',e=>e.onclick=()=>{tfaModal=false;ra()});
  Q('#tfaConfirm',e=>e.onclick=async()=>{const inp=document.getElementById('tfaVInp'),err=document.getElementById('tfaVErr');const code=inp?.value?.replace(/\D/g,'');if(!code||code.length!==6){if(err)err.textContent='6 chiffres';return}if(await verifyTOTP(tfaSetupSecret,code)){totpSecret=tfaSetupSecret;await saveTOTP(tfaSetupSecret);tfaModal=false;tt('üõ°Ô∏è 2FA activ√©');ra()}else{if(err)err.textContent='‚ùå Incorrect';if(inp){inp.value='';inp.focus()}}});
  Q('#tfaMod',e=>e.onclick=v=>{if(v.target===e){tfaModal=false;ra()}});
  Q('#tfaVInp',e=>{e.oninput=()=>{e.value=e.value.replace(/\D/g,'').slice(0,6)}});
  Q('#sySave',e=>e.onclick=()=>{const url=document.getElementById('syUrl')?.value?.trim(),code=document.getElementById('syCode')?.value?.trim();if(!url||!code){tt('‚ùå Requis');return}setSyncConf({url,code});tt('üíæ OK');fullSync();stg=false;ra()});
  Q('#sySync',e=>e.onclick=()=>{fullSync();stg=false});
  Q('#impTg',e=>e.onclick=()=>{stg=false;impModal=true;impData=[];impSel=new Set();ra()});
  Q('#expB',e=>e.onclick=()=>{const b=new Blob([JSON.stringify(C,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`crm_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(u);tt('üì§ OK')});
  Q('#impF',e=>e.onchange=ev=>{const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=async e=>{try{const d=JSON.parse(e.target.result);if(Array.isArray(d)){let n=0;d.forEach(i=>{if(!C.find(c=>c.id===i.id)){C.push(i);n++}});await sv();stg=false;tt(`üì• ${n}`);ra()}}catch(err){tt('‚ùå')}};r.readAsText(f);ev.target.value=''});
  Q('#nukB',e=>e.onclick=async()=>{if(confirm('TOUT supprimer ?')){C=[];await sv();sid=null;vw='list';stg=false;tt('üóëÔ∏è');ra()}});
  Q('#tgF',e=>e.onchange=ev=>{const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);let ct=[];if(d.contacts?.list)ct=d.contacts.list;else if(Array.isArray(d))ct=d;else if(d.contacts&&Array.isArray(d.contacts))ct=d.contacts;impData=ct.filter(c=>c.first_name||c.last_name||c.phone_number);impSel=new Set();ra()}catch(err){tt('‚ùå')}};r.readAsText(f);ev.target.value=''});
  Q('#clImp',e=>e.onclick=()=>{impModal=false;ra()});Q('#impMod',e=>e.onclick=v=>{if(v.target===e){impModal=false;ra()}});
  Q('#selA',e=>e.onclick=()=>{impSel=impSel.size===impData.length?new Set():new Set(impData.map((_,i)=>i));ra()});
  document.querySelectorAll('.imp-item').forEach(el=>el.onclick=()=>{const i=parseInt(el.dataset.ii);impSel.has(i)?impSel.delete(i):impSel.add(i);ra()});
  Q('#doImp',e=>e.onclick=async()=>{let n=0;impSel.forEach(i=>{const tc=impData[i];if(!tc)return;if(!C.find(c=>c.telephone===tc.phone_number&&tc.phone_number)){const nc=mkN();nc.prenom=tc.first_name||'';nc.nom=tc.last_name||'';nc.telephone=tc.phone_number||'';nc.username=tc.username||'';C.push(nc);n++}});await sv();impModal=false;tt(`üì± ${n}`);ra()});
  Q('#si',e=>{e.oninput=()=>{sq=e.value;ra();const el=document.getElementById('si');el?.focus();el.selectionStart=el.selectionEnd=sq.length}});
  Q('#ss',e=>e.onchange=()=>{so=e.value;ra()});Q('#ts',e=>e.onchange=()=>{ft=e.value;ra()});
  document.querySelectorAll('.cc').forEach(c=>c.onclick=()=>{sid=c.dataset.id;vw='detail';mM='';mA='';iDesc='';iAmt='';iCur='EUR';iPaid=false;ra()});
  Q('#bB',e=>e.onclick=()=>{sid=null;dc=null;vw='list';ra()});
  Q('#togFav',e=>e.onclick=async()=>{const c=C.find(x=>x.id===sid);if(c){c.fav=!c.fav;c.lastModified=new Date().toISOString();await sv();ra()}});
  Q('#eB',e=>e.onclick=()=>{const c=C.find(x=>x.id===sid);if(c){ed={...c,monthly:[...(c.monthly||[])],invoices:[...(c.invoices||[])]};vw='form';ra()}});
  Q('#dB',e=>e.onclick=()=>{dc=sid;ra()});
  Q('#cY',e=>e.onclick=async()=>{C=C.filter(c=>c.id!==sid);await sv();sid=null;dc=null;vw='list';tt('üóëÔ∏è');ra()});
  Q('#cN',e=>e.onclick=()=>{dc=null;ra()});
  Q('#iD',e=>e.oninput=()=>iDesc=e.value);Q('#iA',e=>e.oninput=()=>iAmt=e.value);Q('#iC',e=>e.onchange=()=>iCur=e.value);
  Q('#iPR',e=>e.onclick=()=>{iPaid=false;ra()});Q('#iPG',e=>e.onclick=()=>{iPaid=true;ra()});
  Q('#addI',e=>e.onclick=async()=>{if(!iAmt)return;const c=C.find(x=>x.id===sid);if(!c)return;if(!c.invoices)c.invoices=[];c.invoices.push({desc:iDesc||'Facture',amount:Number(iAmt),currency:iCur,paid:iPaid,date:new Date().toISOString().split('T')[0]});c.lastModified=new Date().toISOString();await sv();iDesc='';iAmt='';iPaid=false;tt('üßæ');ra()});
  document.querySelectorAll('.inv-status').forEach(el=>el.onclick=async()=>{const i=parseInt(el.dataset.ti),c=C.find(x=>x.id===sid);if(c?.invoices?.[i]!==undefined){c.invoices[i].paid=!c.invoices[i].paid;c.lastModified=new Date().toISOString();await sv();ra()}});
  document.querySelectorAll('[data-di]').forEach(el=>el.onclick=async()=>{const i=parseInt(el.dataset.di),c=C.find(x=>x.id===sid);if(c?.invoices){c.invoices.splice(i,1);c.lastModified=new Date().toISOString();await sv();ra()}});
  Q('#mMi',e=>e.oninput=()=>mM=e.value);Q('#mAi',e=>e.oninput=()=>mA=e.value);
  Q('#addM',e=>e.onclick=async()=>{if(!mM||!mA)return;const c=C.find(x=>x.id===sid);if(!c)return;if(!c.monthly)c.monthly=[];c.monthly.push({date:mM,amount:Number(mA)});c.lastModified=new Date().toISOString();await sv();mM='';mA='';tt('üìà');ra()});
  document.querySelectorAll('[data-mi]').forEach(el=>el.onclick=async()=>{const i=parseInt(el.dataset.mi),c=C.find(x=>x.id===sid);if(c?.monthly){c.monthly.splice(i,1);c.lastModified=new Date().toISOString();await sv();ra()}});
  const goB=()=>{ed=null;vw=sid?'detail':'list';ra()};
  Q('#fBk',e=>e.onclick=goB);Q('#fCa',e=>e.onclick=goB);
  document.querySelectorAll('.finp[data-f]').forEach(i=>i.oninput=()=>{if(ed)ed[i.dataset.f]=i.value});
  Q('#fSv',e=>e.onclick=async()=>{if(!ed||(!ed.nom&&!ed.prenom))return;ed.lastModified=new Date().toISOString();const x=C.findIndex(c=>c.id===ed.id);if(x>=0){ed.monthly=C[x].monthly||[];ed.invoices=C[x].invoices||[];C[x]={...ed}}else{ed.monthly=[];ed.invoices=[];C.push({...ed})}await sv();sid=ed.id;ed=null;vw='detail';tt('‚úÖ');ra()});
}

async function doChpw(){
  const inp=document.getElementById('chpwInp'),err=document.getElementById('chpwErr'),val=inp?.value||'';
  if(chpwStep===0){if(!await verifyPW(val)){if(err)err.textContent='‚ùå Incorrect';inp.value='';return}chpwStep=1;ra();setTimeout(()=>document.getElementById('chpwInp')?.focus(),100)}
  else if(chpwStep===1){if(val.length<8){if(err)err.textContent='Min 8 car.';return}newPW=val;chpwStep=2;ra();setTimeout(()=>document.getElementById('chpwInp')?.focus(),100)}
  else if(chpwStep===2){if(val!==newPW){if(err)err.textContent='‚ùå Diff√©rent';inp.value='';return}
    masterPW=val;const salt=getSalt();const h=await hashPW(val,salt);localStorage.setItem(HK,h);await saveVault(C);if(totpSecret)await saveTOTP(totpSecret);
    chpwModal=false;newPW='';chpwStep=0;tt('‚úÖ Mot de passe chang√©');ra()}
}

init();
})();
</script>
</body>
</html>
